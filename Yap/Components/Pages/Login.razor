@page "/"
@inject ChatConfigService ChatConfig
@inject ChatService ChatService
@inject UserStateService UserState
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>@ChatConfig.ProjectName</PageTitle>

<div class="username-container">
    <h2>@welcomeMessage</h2>
    <div class="username-form">
        <div class="input-wrapper">
            <input type="text" @bind="usernameInput" @bind:event="oninput" @bind:after="ValidateUsername"
                   placeholder="@usernamePlaceholder" class="username-input @(showError ? "invalid" : "")"
                   @onkeypress="HandleUsernameKeyPress" @onblur="OnInputBlur" maxlength="32" />
            @if (showError)
            {
                <span class="validation-error">@errorMessage</span>
            }
        </div>
        <button class="join-button" @onclick="JoinChat"
                disabled="@(!IsValid)">
            @joinButtonText
        </button>
    </div>
    <div class="build-info">@BuildInfo.Time</div>
</div>

@code {
    private string usernameInput = "";
    private string welcomeMessage = "";
    private string joinButtonText = "";
    private string usernamePlaceholder = "";
    private string errorMessage = "";
    private bool hasError = false;
    private bool isLengthError = false;
    private bool hasBlurred = false;
    private bool isAutoLoggingIn = false;

    // Discord username rules: 2-32 chars, lowercase a-z, 0-9, underscore, period, no consecutive periods
    private static readonly System.Text.RegularExpressions.Regex ValidUsernameRegex =
        new(@"^[a-z0-9._]+$", System.Text.RegularExpressions.RegexOptions.Compiled);

    private bool IsValid => !string.IsNullOrWhiteSpace(usernameInput) && !hasError;

    // Only show length errors after user has blurred the input (finished typing)
    private bool showError => hasError && (!isLengthError || hasBlurred);

    protected override async Task OnInitializedAsync()
    {
        // If already logged in, redirect to chat
        // Note: This works because prerendering is disabled globally in App.razor
        if (UserState.IsLoggedIn)
        {
            try
            {
                Navigation.NavigateTo("/lobby");
            }
            catch (TaskCanceledException)
            {
                // Circuit disconnected during navigation - ignore, reconnection will handle it
            }
            return;
        }

        welcomeMessage = ChatConfig.GetRandomWelcomeMessage();
        joinButtonText = ChatConfig.GetRandomJoinButtonText();
        usernamePlaceholder = ChatConfig.GetRandomUsernamePlaceholder();

        // Check localStorage for stored username
        await TryAutoLoginAsync();
    }

    private async Task TryAutoLoginAsync()
    {
        try
        {
            var storedLoginJson = await JS.InvokeAsync<string?>("getStoredLogin");
            if (string.IsNullOrWhiteSpace(storedLoginJson))
                return;

            var storedLogin = System.Text.Json.JsonSerializer.Deserialize<StoredLogin>(storedLoginJson);
            if (storedLogin == null || string.IsNullOrWhiteSpace(storedLogin.Username))
                return;

            // Remove old session if exists (handles page refresh case)
            if (!string.IsNullOrEmpty(storedLogin.SessionId))
            {
                await ChatService.RemoveUserAsync(storedLogin.SessionId);
            }

            // Check if username is STILL taken by someone else (different session)
            if (ChatService.IsUsernameTaken(storedLogin.Username))
            {
                // Username taken by another user - clear storage and show error
                await JS.InvokeVoidAsync("clearStoredLogin");
                hasError = true;
                hasBlurred = true;
                errorMessage = $"Username '{storedLogin.Username}' is already in use";
                usernameInput = storedLogin.Username;
                return;
            }

            // Auto-login with stored username
            isAutoLoggingIn = true;
            UserState.Username = storedLogin.Username;
            Navigation.NavigateTo("/lobby");
        }
        catch (TaskCanceledException)
        {
            // Circuit disconnected - ignore
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Login] Auto-login failed: {ex.Message}");
        }
    }

    private record StoredLogin(string? Username, string? SessionId);

    private void ValidateUsername()
    {
        hasError = false;
        isLengthError = false;
        errorMessage = "";

        if (string.IsNullOrWhiteSpace(usernameInput))
            return;

        // Auto-trim and convert to lowercase
        var normalized = usernameInput.Trim().ToLowerInvariant();
        if (normalized != usernameInput)
        {
            usernameInput = normalized;
        }

        // Length check (2-32 characters)
        if (usernameInput.Length < 2)
        {
            hasError = true;
            isLengthError = true;
            errorMessage = "Username must be at least 2 characters";
            return;
        }

        // Character validation (a-z, 0-9, underscore, period only)
        if (!ValidUsernameRegex.IsMatch(usernameInput))
        {
            hasError = true;
            errorMessage = "Only lowercase letters, numbers, _ and . allowed";
            return;
        }

        // No consecutive periods
        if (usernameInput.Contains(".."))
        {
            hasError = true;
            errorMessage = "Cannot have consecutive periods";
            return;
        }

        // Username must be unique
        if (ChatService.IsUsernameTaken(usernameInput))
        {
            hasError = true;
            errorMessage = "Username is already taken";
            return;
        }
    }

    private async Task HandleUsernameKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && IsValid) await JoinChat();
    }

    private void OnInputBlur()
    {
        hasBlurred = true;
    }

    private async Task JoinChat()
    {
        if (!IsValid) return;

        var username = usernameInput.Trim();
        UserState.Username = username;

        // Save to localStorage for persistent login
        await JS.InvokeVoidAsync("saveUsername", username);

        try
        {
            Navigation.NavigateTo("/lobby");
        }
        catch (TaskCanceledException)
        {
            // Circuit disconnected during navigation - ignore
        }
    }
}
