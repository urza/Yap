@page "/dm/{DmUser}"
@layout ChatLayout
@inherits ChatBase
@implements IDisposable

<PageTitle>@ChatConfig.ProjectName | @DmUser</PageTitle>

<div class="messages">
    @* DM system notice *@
    <div class="system-message">
        <div class="message-content">
            This is the beginning of your direct message history with <strong>@DmUser</strong>.
            Messages are ephemeral and will disappear when either of you leaves.
        </div>
    </div>

    @for (int i = 0; i < messages.Count; i++)
    {
        var message = messages[i];
        var showHeader = i == 0 || messages[i - 1].Username != message.Username;

        <MessageItem Message="@message"
                     ShowHeader="@showHeader"
                     IsHovered="@(hoveredMessageId == message.Id)"
                     IsEditing="@(editingMessageId == message.Id)"
                     CurrentUsername="@Username"
                     RecentEmojis="@recentEmojis"
                     EditContent="@editContent"
                     EditContentChanged="@(v => editContent = v)"
                     OnMouseEnter="@(() => hoveredMessageId = message.Id)"
                     OnMouseLeave="@(() => hoveredMessageId = null)"
                     OnReaction="@(emoji => ToggleReaction(message.Id, emoji))"
                     OnStartEdit="@(() => StartEdit(message))"
                     OnSaveEdit="SaveEdit"
                     OnCancelEdit="CancelEdit"
                     OnDelete="@(() => DeleteMessage(message.Id))"
                     OnImageClick="@(args => ShowGallery(args.Images, args.Index))" />
    }
</div>

<MessageInput DmUser="@DmUser" />

<ImageGalleryModal Visible="@showImageModal"
                   Images="@modalGallery"
                   StartIndex="@modalImageIndex"
                   OnClose="CloseImageModal" />

@code {
    [Parameter] public string DmUser { get; set; } = "";

    private bool initialized = false;
    // Tracks previous DM user to detect navigation between DMs (e.g., /dm/alice -> /dm/bob)
    // without component recreation - Blazor reuses the component and just updates parameters
    private string? previousDmUser = null;

    protected override async Task OnParametersSetAsync()
    {
        // Detect DM user parameter changes (navigating between DMs)
        if (previousDmUser != null && !previousDmUser.Equals(DmUser, StringComparison.OrdinalIgnoreCase))
        {
            await SwitchDmContentAsync();
        }
        previousDmUser = DmUser;
    }

    protected override async Task OnInitializedChatAsync()
    {
        previousDmUser = DmUser;

        // Get or create DM channel
        var channel = ChatService.GetOrCreateDMChannel(Username, DmUser);
        channelId = channel.Id;

        // Load messages
        messages = ChatService.GetMessages(channelId).ToList();

        // Mark messages as read
        ChatService.MarkDMsAsRead(Username, DmUser);

        // Set navigation context
        currentContext = DmUser;
        NavState.SetDmContext(DmUser);

        await UpdatePageTitleAsync();

        // Subscribe to events
        ChatService.OnMessageReceived += HandleMessageReceived;
        ChatService.OnMessageUpdated += HandleMessageUpdated;
        ChatService.OnMessageDeleted += HandleMessageDeleted;
        ChatService.OnReactionChanged += HandleReactionChanged;
        ChatService.OnUsersListChanged += HandleUsersListChanged;

        initialized = true;
    }

    private async Task SwitchDmContentAsync()
    {
        // Get or create new DM channel
        var channel = ChatService.GetOrCreateDMChannel(Username, DmUser);
        channelId = channel.Id;

        // Load messages
        messages = ChatService.GetMessages(channelId).ToList();

        // Mark as read
        ChatService.MarkDMsAsRead(Username, DmUser);

        // Update context
        currentContext = DmUser;
        NavState.SetDmContext(DmUser);

        await UpdatePageTitleAsync();
        await InvokeAsync(StateHasChanged);
        await ScrollToBottomAsync();
    }

    #region DM-Specific Event Handlers

    private async Task HandleMessageReceived(ChatMessage message)
    {
        await InvokeAsync(async () =>
        {
            if (message.ChannelId == channelId)
            {
                messages.Add(message);
                ChatService.MarkDMsAsRead(Username, DmUser);
                StateHasChanged();
                await ScrollToBottomAsync();
            }

            if (!message.Username.Equals(Username, StringComparison.OrdinalIgnoreCase))
            {
                await HandleNewMessageNotificationAsync(message.Username, isDM: true);
            }
        });
    }

    private async Task HandleUsersListChanged()
    {
        await InvokeAsync(() =>
        {
            // If the DM user left, go back to lobby (only after initialization)
            if (initialized)
            {
                var onlineUsers = ChatService.GetOnlineUsers();
                if (!onlineUsers.Any(u => u.Equals(DmUser, StringComparison.OrdinalIgnoreCase)))
                {
                    Navigation.NavigateTo("/lobby");
                }
            }
        });
    }

    #endregion

    public void Dispose()
    {
        ChatService.OnMessageReceived -= HandleMessageReceived;
        ChatService.OnMessageUpdated -= HandleMessageUpdated;
        ChatService.OnMessageDeleted -= HandleMessageDeleted;
        ChatService.OnReactionChanged -= HandleReactionChanged;
        ChatService.OnUsersListChanged -= HandleUsersListChanged;
    }
}
