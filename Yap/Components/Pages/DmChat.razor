@page "/dm/{DmUser}"
@layout ChatLayout
@inherits ChatBase
@implements IDisposable

<PageTitle>@ChatConfig.ProjectName | @DmUser</PageTitle>

<div class="messages">
    @* DM system notice *@
    <div class="system-message">
        <div class="message-content">
            This is the beginning of your direct message history with <strong>@DmUser</strong>.
            Messages are ephemeral and will disappear when either of you leaves.
        </div>
    </div>

    @for (int i = 0; i < dmMessages.Count; i++)
    {
        var message = dmMessages[i];
        var showHeader = i == 0 || dmMessages[i - 1].FromUser != message.FromUser;

        <MessageItem Username="@message.FromUser"
                     Content="@message.Content"
                     Timestamp="@message.Timestamp"
                     ShowHeader="@showHeader"
                     IsOwn="@message.FromUser.Equals(Username, StringComparison.OrdinalIgnoreCase)"
                     IsSystem="false"
                     IsEdited="@message.IsEdited"
                     IsHovered="@(hoveredDMId == message.Id)"
                     IsEditing="@(editingDMId == message.Id)"
                     HasImages="@message.HasImages"
                     ImageUrls="@message.ImageUrls"
                     ShowReactions="false"
                     CurrentUsername="@Username"
                     EditContent="@editDMContent"
                     EditContentChanged="@(v => editDMContent = v)"
                     OnMouseEnter="@(() => hoveredDMId = message.Id)"
                     OnMouseLeave="@(() => hoveredDMId = null)"
                     OnStartEdit="@(() => StartDMEdit(message))"
                     OnSaveEdit="SaveDMEdit"
                     OnCancelEdit="CancelDMEdit"
                     OnDelete="@(() => DeleteDM(message.Id))"
                     OnImageClick="@(args => ShowGallery(args.Images, args.Index))" />
    }
</div>

<MessageInput DmUser="@DmUser" />

<ImageGalleryModal Visible="@showImageModal"
                   Images="@modalGallery"
                   StartIndex="@modalImageIndex"
                   OnClose="CloseImageModal" />

@code {
    [Parameter] public string DmUser { get; set; } = "";

    // State
    private List<DirectMessage> dmMessages = new();
    private Guid? hoveredDMId = null;
    private Guid? editingDMId = null;
    private string editDMContent = "";
    private bool initialized = false;
    private string? previousDmUser = null;

    protected override async Task OnParametersSetAsync()
    {
        // Detect DM user parameter changes (navigating between DMs)
        if (previousDmUser != null && !previousDmUser.Equals(DmUser, StringComparison.OrdinalIgnoreCase))
        {
            await SwitchDmContentAsync();
        }
        previousDmUser = DmUser;
    }

    protected override async Task OnInitializedChatAsync()
    {
        previousDmUser = DmUser;

        // Load DM messages
        dmMessages = ChatService.GetDirectMessages(Username, DmUser).ToList();

        // Mark messages as read
        ChatService.MarkDMsAsRead(Username, DmUser);

        // Set navigation context
        currentContext = DmUser;
        NavState.SetDmContext(DmUser);

        await UpdatePageTitleAsync();

        // Subscribe to events
        ChatService.OnDirectMessageReceived += HandleDirectMessageReceived;
        ChatService.OnDirectMessageUpdated += HandleDirectMessageUpdated;
        ChatService.OnDirectMessageDeleted += HandleDirectMessageDeleted;
        ChatService.OnUsersListChanged += HandleUsersListChanged;

        initialized = true;
    }

    private async Task SwitchDmContentAsync()
    {
        // Load new DM messages
        dmMessages = ChatService.GetDirectMessages(Username, DmUser).ToList();

        // Mark as read
        ChatService.MarkDMsAsRead(Username, DmUser);

        // Update context
        currentContext = DmUser;
        NavState.SetDmContext(DmUser);

        await UpdatePageTitleAsync();
        await InvokeAsync(StateHasChanged);
        await ScrollToBottomAsync();
    }

    #region Event Handlers

    private async Task HandleDirectMessageReceived(DirectMessage message)
    {
        await InvokeAsync(async () =>
        {
            var isForThisConversation =
                (message.FromUser.Equals(Username, StringComparison.OrdinalIgnoreCase) &&
                 message.ToUser.Equals(DmUser, StringComparison.OrdinalIgnoreCase)) ||
                (message.FromUser.Equals(DmUser, StringComparison.OrdinalIgnoreCase) &&
                 message.ToUser.Equals(Username, StringComparison.OrdinalIgnoreCase));

            if (isForThisConversation)
            {
                dmMessages.Add(message);
                ChatService.MarkDMsAsRead(Username, DmUser);
                StateHasChanged();
                await ScrollToBottomAsync();
            }

            if (!message.FromUser.Equals(Username, StringComparison.OrdinalIgnoreCase))
            {
                await HandleNewMessageNotificationAsync(message.FromUser, isDM: true);
            }
        });
    }

    private async Task HandleDirectMessageUpdated(DirectMessage message)
    {
        await InvokeAsync(() =>
        {
            var otherUser = message.FromUser.Equals(Username, StringComparison.OrdinalIgnoreCase)
                ? message.ToUser
                : message.FromUser;

            if (DmUser.Equals(otherUser, StringComparison.OrdinalIgnoreCase))
            {
                var index = dmMessages.FindIndex(m => m.Id == message.Id);
                if (index >= 0) dmMessages[index] = message;
                StateHasChanged();
            }
        });
    }

    private async Task HandleDirectMessageDeleted(Guid messageId, string conversationKey)
    {
        await InvokeAsync(() =>
        {
            var key = DirectMessage.GetConversationKey(Username, DmUser);
            if (key == conversationKey)
            {
                dmMessages.RemoveAll(m => m.Id == messageId);
                StateHasChanged();
            }
        });
    }

    private async Task HandleUsersListChanged()
    {
        await InvokeAsync(() =>
        {
            // If the DM user left, go back to lobby (only after initialization)
            if (initialized)
            {
                var onlineUsers = ChatService.GetOnlineUsers();
                if (!onlineUsers.Any(u => u.Equals(DmUser, StringComparison.OrdinalIgnoreCase)))
                {
                    Navigation.NavigateTo("/lobby");
                }
            }
        });
    }

    #endregion

    #region Message Actions

    private void StartDMEdit(DirectMessage message)
    {
        editingDMId = message.Id;
        editDMContent = message.Content;
    }

    private async Task SaveDMEdit()
    {
        if (editingDMId.HasValue && !string.IsNullOrWhiteSpace(editDMContent))
        {
            await ChatService.EditDirectMessageAsync(editingDMId.Value, Username, DmUser, editDMContent);
        }
        CancelDMEdit();
    }

    private void CancelDMEdit()
    {
        editingDMId = null;
        editDMContent = "";
    }

    private async Task DeleteDM(Guid messageId)
    {
        await ChatService.DeleteDirectMessageAsync(messageId, Username, DmUser);
    }

    #endregion

    public void Dispose()
    {
        ChatService.OnDirectMessageReceived -= HandleDirectMessageReceived;
        ChatService.OnDirectMessageUpdated -= HandleDirectMessageUpdated;
        ChatService.OnDirectMessageDeleted -= HandleDirectMessageDeleted;
        ChatService.OnUsersListChanged -= HandleUsersListChanged;
    }
}
