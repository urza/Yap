@page "/chat"
@page "/lobby"
@page "/room/{RoomId:guid}"
@page "/dm/{DmUser}"
@inject ChatService ChatService
@inject ChatConfigService ChatConfig
@inject EmojiService EmojiService
@inject UserStateService UserState
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IWebHostEnvironment Environment
@implements IAsyncDisposable

<PageTitle>@pageTitle</PageTitle>

<div class="chat-container">
    <ChatHeader Title="@GetCurrentViewHeader()"
                Username="@username"
                TotalUnreadDMs="@totalUnreadDMs"
                OnlineCount="@onlineUsers.Count"
                OnMailboxClick="OpenSidebarForDMs"
                OnToggleSidebar="ToggleSidebar" />

    <div class="chat-main">
        <div class="messages-container">
            <div class="messages" @ref="messagesElement">
                @if (currentDMUser == null)
                {
                    @* Room messages *@
                    @for (int i = 0; i < messages.Count; i++)
                    {
                        var message = messages[i];
                        var isSystemMessage = message.Username == "System";
                        var showHeader = !isSystemMessage && (i == 0 || messages[i - 1].Username != message.Username);

                        <MessageItem Username="@message.Username"
                                     Content="@message.Content"
                                     Timestamp="@message.Timestamp"
                                     ShowHeader="@showHeader"
                                     IsOwn="@(message.Username == username)"
                                     IsSystem="@isSystemMessage"
                                     IsEdited="@message.IsEdited"
                                     IsHovered="@(hoveredMessageId == message.Id)"
                                     IsEditing="@(editingMessageId == message.Id)"
                                     HasImages="@message.HasImages"
                                     ImageUrls="@message.ImageUrls"
                                     Reactions="@message.Reactions"
                                     ShowReactions="true"
                                     CurrentUsername="@username"
                                     EditContent="@editContent"
                                     EditContentChanged="@(v => editContent = v)"
                                     OnMouseEnter="@(() => hoveredMessageId = message.Id)"
                                     OnMouseLeave="@(() => hoveredMessageId = null)"
                                     OnReaction="@(emoji => ToggleReaction(message.Id, emoji))"
                                     OnStartEdit="@(() => StartEdit(message))"
                                     OnSaveEdit="SaveEdit"
                                     OnCancelEdit="CancelEdit"
                                     OnDelete="@(() => DeleteMessage(message.Id))"
                                     OnImageClick="@(args => ShowGallery(args.Images, args.Index))" />
                    }
                }
                else
                {
                    @* DM system notice *@
                    <div class="message-group system-message">
                        <div class="message-content">
                            This is the beginning of your direct message history with <strong>@currentDMUser</strong>.
                            Messages are ephemeral and will disappear when either of you leaves.
                        </div>
                    </div>

                    @* DM messages *@
                    @for (int i = 0; i < dmMessages.Count; i++)
                    {
                        var message = dmMessages[i];
                        var showHeader = i == 0 || dmMessages[i - 1].FromUser != message.FromUser;

                        <MessageItem Username="@message.FromUser"
                                     Content="@message.Content"
                                     Timestamp="@message.Timestamp"
                                     ShowHeader="@showHeader"
                                     IsOwn="@message.FromUser.Equals(username, StringComparison.OrdinalIgnoreCase)"
                                     IsSystem="false"
                                     IsEdited="@message.IsEdited"
                                     IsHovered="@(hoveredDMId == message.Id)"
                                     IsEditing="@(editingDMId == message.Id)"
                                     HasImages="@message.HasImages"
                                     ImageUrls="@message.ImageUrls"
                                     ShowReactions="false"
                                     CurrentUsername="@username"
                                     EditContent="@editDMContent"
                                     EditContentChanged="@(v => editDMContent = v)"
                                     OnMouseEnter="@(() => hoveredDMId = message.Id)"
                                     OnMouseLeave="@(() => hoveredDMId = null)"
                                     OnStartEdit="@(() => StartDMEdit(message))"
                                     OnSaveEdit="SaveDMEdit"
                                     OnCancelEdit="CancelDMEdit"
                                     OnDelete="@(() => DeleteDM(message.Id))"
                                     OnImageClick="@(args => ShowGallery(args.Images, args.Index))" />
                    }
                }
            </div>

            <MessageInput @bind-MessageText="messageInput"
                          Placeholder="@GetMessagePlaceholder()"
                          TypingIndicatorText="@typingIndicatorText"
                          OnSend="SendMessage"
                          OnFilesSelected="HandleFileSelected"
                          OnInputChanged="HandleInputChanged" />
        </div>

        <ChatSidebar Rooms="rooms"
                     CurrentRoomId="currentRoomId"
                     CurrentDMUser="currentDMUser"
                     Username="username"
                     OnlineUsersHeader="@onlineUsersHeader"
                     IsAdmin="isAdmin"
                     SidebarOpen="sidebarOpen"
                     OnSwitchRoom="SwitchToRoom"
                     OnDeleteRoom="DeleteRoom"
                     OnOpenDM="OpenDM"
                     OnCreateRoom="CreateRoom"
                     GetUnreadDMCount="GetUnreadDMCount"
                     GetSortedUsers="GetSortedUsers" />
    </div>
    <div class="sidebar-backdrop @(sidebarOpen ? "show" : "")" @onclick="ToggleSidebar"></div>
</div>

<ImageGalleryModal Visible="@showImageModal"
                   Images="@modalGallery"
                   StartIndex="@modalImageIndex"
                   OnClose="CloseImageModal" />

@code {
    // Route parameters (for URL display only, deep linking not yet supported)
    [Parameter] public Guid? RoomId { get; set; }
    [Parameter] public string? DmUser { get; set; }

    private string circuitId = Guid.NewGuid().ToString();

    // State
    private string username => UserState.Username ?? "";
    private string messageInput = "";
    private List<ChatMessage> messages = new();
    private List<string> onlineUsers = new();
    private List<string> typingUsers = new();
    private ElementReference messagesElement;
    private bool showImageModal = false;
    private List<string> modalGallery = new();
    private int modalImageIndex = 0;
    private bool sidebarOpen = false;
    private System.Timers.Timer? typingTimer;
    private bool isTyping = false;

    // Room state
    private List<Room> rooms = new();
    private Guid currentRoomId;
    private bool isAdmin = false;

    // DM state
    private string? currentDMUser = null;
    private List<DirectMessage> dmMessages = new();
    private List<string> dmTypingUsers = new();
    private Dictionary<string, int> dmUnreadCounts = new();

    // Message actions state (room)
    private Guid? hoveredMessageId = null;
    private Guid? editingMessageId = null;
    private string editContent = "";

    // Message actions state (DM)
    private Guid? hoveredDMId = null;
    private Guid? editingDMId = null;
    private string editDMContent = "";

    // Tab notifications
    private int unreadCount = 0;
    private string pageTitle = "Yap";
    private string currentContext = "";

    // Total unread DMs for mailbox icon
    private int totalUnreadDMs = 0;

    // UI Text
    private string messagePlaceholder = "";
    private string onlineUsersHeader = "";
    private string typingIndicatorText = "";

    protected override void OnInitialized()
    {
        messagePlaceholder = ChatConfig.GetRandomMessagePlaceholder();
        UpdateOnlineUsersHeader();
        pageTitle = ChatConfig.ProjectName;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Redirect to login if not logged in (check here to avoid prerender issues)
            if (!UserState.IsLoggedIn)
            {
                Navigation.NavigateTo("/");
                return;
            }

            await InitializeChat();
        }
    }

    private string GetCurrentViewHeader()
    {
        if (currentDMUser != null)
            return $"DM with {currentDMUser}";

        var room = rooms.FirstOrDefault(r => r.Id == currentRoomId);
        return room != null ? $"# {room.Name}" : ChatConfig.GetRandomRoomHeader();
    }

    private string GetMessagePlaceholder()
    {
        if (currentDMUser != null)
            return $"Message @{currentDMUser}";
        return messagePlaceholder;
    }

    private async Task InitializeChat()
    {
        // Subscribe to events
        ChatService.OnMessageReceived += HandleMessageReceived;
        ChatService.OnMessageUpdated += HandleMessageUpdated;
        ChatService.OnMessageDeleted += HandleMessageDeleted;
        ChatService.OnReactionChanged += HandleReactionChanged;
        ChatService.OnUserChanged += HandleUserChanged;
        ChatService.OnUsersListChanged += HandleUsersListChanged;
        ChatService.OnTypingUsersChanged += HandleTypingUsersChanged;
        ChatService.OnRoomCreated += HandleRoomCreated;
        ChatService.OnRoomDeleted += HandleRoomDeleted;
        ChatService.OnAdminChanged += HandleAdminChanged;
        ChatService.OnDirectMessageReceived += HandleDirectMessageReceived;
        ChatService.OnDirectMessageUpdated += HandleDirectMessageUpdated;
        ChatService.OnDirectMessageDeleted += HandleDirectMessageDeleted;
        ChatService.OnDMTypingUsersChanged += HandleDMTypingUsersChanged;

        // Load rooms
        rooms = ChatService.GetRooms();
        currentRoomId = ChatService.LobbyId;

        // Load room history
        messages = ChatService.GetRoomMessages(currentRoomId).ToList();
        onlineUsers = ChatService.GetOnlineUsers();
        UpdateOnlineUsersHeader();

        // Join chat
        await ChatService.AddUserAsync(circuitId, username);

        // Check if we're admin
        isAdmin = ChatService.IsAdmin(username);

        // Refresh users after join (to include ourselves)
        onlineUsers = ChatService.GetOnlineUsers();
        UpdateOnlineUsersHeader();

        // Setup tab notifications
        await SetupTabNotifications();
        await UpdatePageTitle();

        // Set initial URL
        UpdateUrl();

        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    #region Room Management

    private async Task SwitchToRoom(Guid roomId)
    {
        if (currentRoomId == roomId && currentDMUser == null) return;

        currentDMUser = null;
        currentRoomId = roomId;
        messages = ChatService.GetRoomMessages(roomId).ToList();
        typingUsers = ChatService.GetTypingUsers(roomId);
        UpdateTypingIndicator();

        // Reset unread count when switching
        unreadCount = 0;
        await UpdatePageTitle();

        // Update URL
        UpdateUrl();

        // Auto-close sidebar on mobile
        sidebarOpen = false;

        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    private async Task CreateRoom(string roomName)
    {
        if (string.IsNullOrWhiteSpace(roomName)) return;
        await ChatService.CreateRoomAsync(username, roomName);
    }

    private async Task DeleteRoom(Guid roomId)
    {
        await ChatService.DeleteRoomAsync(username, roomId);
    }

    #endregion

    #region DM Management

    private async Task OpenDM(string targetUser)
    {
        if (targetUser.Equals(username, StringComparison.OrdinalIgnoreCase)) return;

        currentDMUser = targetUser;
        dmMessages = ChatService.GetDirectMessages(username, targetUser).ToList();
        dmTypingUsers = ChatService.GetDMTypingUsers(username, targetUser);
        UpdateTypingIndicator();

        // Mark messages as read
        ChatService.MarkDMsAsRead(username, targetUser);
        dmUnreadCounts[targetUser.ToLowerInvariant()] = 0;
        UpdateTotalUnreadDMs();

        // Reset unread count
        unreadCount = 0;
        await UpdatePageTitle();

        // Update URL
        UpdateUrl();

        // Auto-close sidebar on mobile
        sidebarOpen = false;

        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    private int GetUnreadDMCount(string fromUser)
    {
        var key = fromUser.ToLowerInvariant();
        return dmUnreadCounts.TryGetValue(key, out var count) ? count : 0;
    }

    private void UpdateTotalUnreadDMs()
    {
        totalUnreadDMs = dmUnreadCounts.Values.Sum();
    }

    private void OpenSidebarForDMs()
    {
        sidebarOpen = true;
    }

    /// <summary>
    /// Gets users sorted by: unread first (by last message time), then others by last message time
    /// </summary>
    private IEnumerable<string> GetSortedUsers()
    {
        // Separate current user from others
        var currentUserList = onlineUsers.Where(u => u.Equals(username, StringComparison.OrdinalIgnoreCase));
        var otherUsers = onlineUsers.Where(u => !u.Equals(username, StringComparison.OrdinalIgnoreCase)).ToList();

        // Sort others: unread first, then by last DM timestamp descending
        var sorted = otherUsers
            .Select(u => new
            {
                User = u,
                UnreadCount = GetUnreadDMCount(u),
                LastDM = ChatService.GetLastDMTimestamp(username, u)
            })
            .OrderByDescending(x => x.UnreadCount > 0) // Unread first
            .ThenByDescending(x => x.LastDM ?? DateTime.MinValue) // Most recent DM
            .ThenBy(x => x.User) // Alphabetical fallback
            .Select(x => x.User);

        // Current user stays at top
        return currentUserList.Concat(sorted);
    }

    #endregion

    #region Event Handlers (Room)

    private async Task HandleMessageReceived(ChatMessage message)
    {
        await InvokeAsync(async () =>
        {
            // Only add if it's for the current room
            if (message.RoomId == currentRoomId && currentDMUser == null)
            {
                messages.Add(message);
                StateHasChanged();
                await ScrollToBottom();
            }

            // Handle notification for room messages (no sound, just count)
            if (message.Username != username && message.Username != "System" && currentDMUser == null)
            {
                await HandleNewMessageNotification(message.Username, isDM: false);
            }
        });
    }

    private async Task HandleMessageUpdated(ChatMessage message)
    {
        await InvokeAsync(() =>
        {
            if (message.RoomId == currentRoomId && currentDMUser == null)
            {
                var index = messages.FindIndex(m => m.Id == message.Id);
                if (index >= 0)
                {
                    messages[index] = message;
                }
                StateHasChanged();
            }
            return Task.CompletedTask;
        });
    }

    private async Task HandleMessageDeleted(Guid messageId, Guid roomId)
    {
        await InvokeAsync(() =>
        {
            if (roomId == currentRoomId && currentDMUser == null)
            {
                messages.RemoveAll(m => m.Id == messageId);
                StateHasChanged();
            }
            return Task.CompletedTask;
        });
    }

    private async Task HandleReactionChanged(ChatMessage message)
    {
        await InvokeAsync(() =>
        {
            if (message.RoomId == currentRoomId && currentDMUser == null)
            {
                var index = messages.FindIndex(m => m.Id == message.Id);
                if (index >= 0)
                {
                    messages[index] = message;
                }
                StateHasChanged();
            }
            return Task.CompletedTask;
        });
    }

    private async Task HandleUserChanged(string user, bool isJoining)
    {
        await InvokeAsync(() =>
        {
            // System message for lobby
            if (currentRoomId == ChatService.LobbyId && currentDMUser == null)
            {
                messages.Add(new ChatMessage(
                    ChatService.LobbyId,
                    "System",
                    ChatConfig.GetRandomSystemMessage(user, isJoining),
                    DateTime.UtcNow
                ));
                StateHasChanged();
            }
            return Task.CompletedTask;
        });
    }

    private async Task HandleUsersListChanged()
    {
        await InvokeAsync(async () =>
        {
            onlineUsers = ChatService.GetOnlineUsers();
            UpdateOnlineUsersHeader();

            // If viewing DM with someone who left, go back to room
            if (currentDMUser != null && !onlineUsers.Any(u => u.Equals(currentDMUser, StringComparison.OrdinalIgnoreCase)))
            {
                currentDMUser = null;
                dmMessages.Clear();
                messages = ChatService.GetRoomMessages(currentRoomId).ToList();
                await UpdatePageTitle();
                UpdateUrl();
            }

            StateHasChanged();
        });
    }

    private async Task HandleTypingUsersChanged(Guid roomId)
    {
        await InvokeAsync(() =>
        {
            if (roomId == currentRoomId && currentDMUser == null)
            {
                typingUsers = ChatService.GetTypingUsers(roomId);
                UpdateTypingIndicator();
                StateHasChanged();
            }
            return Task.CompletedTask;
        });
    }

    private async Task HandleRoomCreated(Room room)
    {
        await InvokeAsync(() =>
        {
            rooms = ChatService.GetRooms();
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    private async Task HandleRoomDeleted(Guid roomId)
    {
        await InvokeAsync(() =>
        {
            rooms = ChatService.GetRooms();

            // If we were in the deleted room, switch to lobby
            if (currentRoomId == roomId)
            {
                currentRoomId = ChatService.LobbyId;
                messages = ChatService.GetRoomMessages(currentRoomId).ToList();
                UpdateUrl();
            }

            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    private async Task HandleAdminChanged(string? adminUser)
    {
        await InvokeAsync(() =>
        {
            isAdmin = ChatService.IsAdmin(username);
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    #endregion

    #region Event Handlers (DM)

    private async Task HandleDirectMessageReceived(DirectMessage message)
    {
        await InvokeAsync(async () =>
        {
            var isForMe = message.ToUser.Equals(username, StringComparison.OrdinalIgnoreCase) ||
                          message.FromUser.Equals(username, StringComparison.OrdinalIgnoreCase);

            if (!isForMe) return;

            var otherUser = message.FromUser.Equals(username, StringComparison.OrdinalIgnoreCase)
                ? message.ToUser
                : message.FromUser;

            // If this DM is currently open, add to view
            if (currentDMUser != null && currentDMUser.Equals(otherUser, StringComparison.OrdinalIgnoreCase))
            {
                dmMessages.Add(message);
                ChatService.MarkDMsAsRead(username, otherUser);
                StateHasChanged();
                await ScrollToBottom();
            }
            else if (message.ToUser.Equals(username, StringComparison.OrdinalIgnoreCase))
            {
                // Increment unread count for this sender
                var key = otherUser.ToLowerInvariant();
                if (!dmUnreadCounts.ContainsKey(key))
                    dmUnreadCounts[key] = 0;
                dmUnreadCounts[key]++;
                UpdateTotalUnreadDMs();
                StateHasChanged();
            }

            // Handle notification for DMs (with sound!)
            if (!message.FromUser.Equals(username, StringComparison.OrdinalIgnoreCase))
            {
                await HandleNewMessageNotification(message.FromUser, isDM: true);
            }
        });
    }

    private async Task HandleDirectMessageUpdated(DirectMessage message)
    {
        await InvokeAsync(() =>
        {
            var otherUser = message.FromUser.Equals(username, StringComparison.OrdinalIgnoreCase)
                ? message.ToUser
                : message.FromUser;

            if (currentDMUser != null && currentDMUser.Equals(otherUser, StringComparison.OrdinalIgnoreCase))
            {
                var index = dmMessages.FindIndex(m => m.Id == message.Id);
                if (index >= 0)
                {
                    dmMessages[index] = message;
                }
                StateHasChanged();
            }
            return Task.CompletedTask;
        });
    }

    private async Task HandleDirectMessageDeleted(Guid messageId, string conversationKey)
    {
        await InvokeAsync(() =>
        {
            if (currentDMUser != null)
            {
                var key = DirectMessage.GetConversationKey(username, currentDMUser);
                if (key == conversationKey)
                {
                    dmMessages.RemoveAll(m => m.Id == messageId);
                    StateHasChanged();
                }
            }
            return Task.CompletedTask;
        });
    }

    private async Task HandleDMTypingUsersChanged(string conversationKey)
    {
        await InvokeAsync(() =>
        {
            if (currentDMUser != null)
            {
                var key = DirectMessage.GetConversationKey(username, currentDMUser);
                if (key == conversationKey)
                {
                    dmTypingUsers = ChatService.GetDMTypingUsers(username, currentDMUser);
                    UpdateTypingIndicator();
                    StateHasChanged();
                }
            }
            return Task.CompletedTask;
        });
    }

    #endregion

    #region Send Messages

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(messageInput)) return;

        if (currentDMUser != null)
        {
            await ChatService.SendDirectMessageAsync(username, currentDMUser, messageInput);
        }
        else
        {
            await ChatService.SendMessageAsync(currentRoomId, username, messageInput);
        }

        messageInput = "";
        await StopTyping();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles(10);
        if (files.Count == 0) return;

        var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".webp" };
        var imageUrls = new List<string>();

        try
        {
            var uploadsFolder = Path.Combine(Environment.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsFolder);

            foreach (var file in files)
            {
                var extension = Path.GetExtension(file.Name).ToLowerInvariant();
                if (!allowedExtensions.Contains(extension)) continue;
                if (file.Size > 100 * 1024 * 1024) continue;

                var uniqueFileName = $"{Guid.NewGuid()}{extension}";
                var filePath = Path.Combine(uploadsFolder, uniqueFileName);

                await using var stream = new FileStream(filePath, FileMode.Create);
                await file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024).CopyToAsync(stream);

                imageUrls.Add($"/uploads/{uniqueFileName}");
            }

            if (imageUrls.Count > 0)
            {
                if (currentDMUser != null)
                {
                    await ChatService.SendDirectMessageAsync(username, currentDMUser, "", imageUrls);
                }
                else
                {
                    await ChatService.SendMessageAsync(currentRoomId, username, "", imageUrls);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading files: {ex.Message}");
        }
    }

    #endregion

    #region Message Actions (Room)


    private async Task ToggleReaction(Guid messageId, string emoji)
    {
        await ChatService.ToggleReactionAsync(messageId, currentRoomId, username, emoji);
    }

    private void StartEdit(ChatMessage message)
    {
        editingMessageId = message.Id;
        editContent = message.Content;
    }

    private async Task SaveEdit()
    {
        if (editingMessageId.HasValue && !string.IsNullOrWhiteSpace(editContent))
        {
            await ChatService.EditMessageAsync(editingMessageId.Value, currentRoomId, username, editContent);
        }
        CancelEdit();
    }

    private void CancelEdit()
    {
        editingMessageId = null;
        editContent = "";
    }

    private async Task DeleteMessage(Guid messageId)
    {
        await ChatService.DeleteMessageAsync(messageId, currentRoomId, username);
    }

    #endregion

    #region Message Actions (DM)

    private void StartDMEdit(DirectMessage message)
    {
        editingDMId = message.Id;
        editDMContent = message.Content;
    }

    private async Task SaveDMEdit()
    {
        if (editingDMId.HasValue && !string.IsNullOrWhiteSpace(editDMContent) && currentDMUser != null)
        {
            await ChatService.EditDirectMessageAsync(editingDMId.Value, username, currentDMUser, editDMContent);
        }
        CancelDMEdit();
    }

    private void CancelDMEdit()
    {
        editingDMId = null;
        editDMContent = "";
    }

    private async Task DeleteDM(Guid messageId)
    {
        if (currentDMUser != null)
        {
            await ChatService.DeleteDirectMessageAsync(messageId, username, currentDMUser);
        }
    }

    #endregion

    #region Typing Indicators

    private async Task HandleInputChanged()
    {
        await HandleTypingChangeAsync(messageInput);
    }

    private async Task HandleTypingChangeAsync(string currentValue)
    {
        if (!string.IsNullOrWhiteSpace(currentValue) && !isTyping)
        {
            await StartTyping();
        }
        else if (string.IsNullOrWhiteSpace(currentValue) && isTyping)
        {
            await StopTyping();
        }

        typingTimer?.Stop();
        typingTimer?.Dispose();

        if (!string.IsNullOrWhiteSpace(currentValue))
        {
            typingTimer = new System.Timers.Timer(3000);
            typingTimer.Elapsed += async (s, e) =>
            {
                await StopTyping();
                typingTimer?.Dispose();
            };
            typingTimer.Start();
        }
    }

    private async Task StartTyping()
    {
        if (!isTyping)
        {
            isTyping = true;
            if (currentDMUser != null)
            {
                await ChatService.StartDMTypingAsync(username, currentDMUser);
            }
            else
            {
                await ChatService.StartTypingAsync(currentRoomId, username);
            }
        }
    }

    private async Task StopTyping()
    {
        if (isTyping)
        {
            isTyping = false;
            if (currentDMUser != null)
            {
                await ChatService.StopDMTypingAsync(username, currentDMUser);
            }
            else
            {
                await ChatService.StopTypingAsync(currentRoomId, username);
            }
            typingTimer?.Stop();
            typingTimer?.Dispose();
        }
    }

    #endregion

    #region Notifications

    private async Task SetupTabNotifications()
    {
        try { await JS.InvokeVoidAsync("setupVisibilityListener", DotNetObjectReference.Create(this)); } catch { }
    }

    private async Task HandleNewMessageNotification(string messageUser, bool isDM)
    {
        try
        {
            var isVisible = await JS.InvokeAsync<bool>("isPageVisible");
            if (!isVisible)
            {
                unreadCount++;
                var title = $"({unreadCount}) {ChatConfig.ProjectName} | {currentContext}";

                if (isDM)
                {
                    // DMs get sound
                    await JS.InvokeVoidAsync("notifyNewMessage", title);
                }
                else
                {
                    // Room messages just update title
                    await JS.InvokeVoidAsync("setDocumentTitle", title);
                }
            }
        }
        catch { }
    }

    [JSInvokable]
    public async Task OnPageBecameVisible()
    {
        if (unreadCount > 0)
        {
            unreadCount = 0;
            await UpdatePageTitle();
            await InvokeAsync(StateHasChanged);
        }
    }

    #endregion

    #region UI Helpers

    private async Task ScrollToBottom()
    {
        try { await JS.InvokeVoidAsync("scrollToBottom", messagesElement); } catch { }
    }

    private void ShowGallery(List<string> gallery, int startIndex)
    {
        modalGallery = gallery;
        modalImageIndex = startIndex;
        showImageModal = true;
    }

    private void CloseImageModal()
    {
        showImageModal = false;
        modalGallery = new();
        modalImageIndex = 0;
    }

    private void ToggleSidebar() => sidebarOpen = !sidebarOpen;

    private void UpdateOnlineUsersHeader() =>
        onlineUsersHeader = ChatConfig.GetRandomOnlineUsersHeader(onlineUsers.Count);

    private async Task UpdatePageTitle()
    {
        if (currentDMUser != null)
        {
            currentContext = currentDMUser;
        }
        else
        {
            var room = rooms.FirstOrDefault(r => r.Id == currentRoomId);
            currentContext = room?.Name ?? "lobby";
        }

        var title = unreadCount > 0
            ? $"({unreadCount}) {ChatConfig.ProjectName} | {currentContext}"
            : $"{ChatConfig.ProjectName} | {currentContext}";

        pageTitle = title;
        try { await JS.InvokeVoidAsync("setDocumentTitle", title); } catch { }
    }

    private void UpdateTypingIndicator()
    {
        if (currentDMUser != null)
        {
            // DM typing - filter out self
            var others = dmTypingUsers.Where(u => !u.Equals(username, StringComparison.OrdinalIgnoreCase)).ToList();
            typingIndicatorText = others.Count > 0 ? $"{string.Join(", ", others)} is typing..." : "";
        }
        else
        {
            typingIndicatorText = ChatConfig.GetRandomTypingIndicator(typingUsers, username);
        }
    }

    private void UpdateUrl()
    {
        string url;
        if (currentDMUser != null)
        {
            url = $"/dm/{Uri.EscapeDataString(currentDMUser)}";
        }
        else if (currentRoomId == ChatService.LobbyId)
        {
            url = "/lobby";
        }
        else
        {
            url = $"/room/{currentRoomId}";
        }

        Navigation.NavigateTo(url, forceLoad: false, replace: true);
    }

    #endregion

    public async ValueTask DisposeAsync()
    {
        typingTimer?.Stop();
        typingTimer?.Dispose();

        if (!string.IsNullOrEmpty(username))
        {
            ChatService.OnMessageReceived -= HandleMessageReceived;
            ChatService.OnMessageUpdated -= HandleMessageUpdated;
            ChatService.OnMessageDeleted -= HandleMessageDeleted;
            ChatService.OnReactionChanged -= HandleReactionChanged;
            ChatService.OnUserChanged -= HandleUserChanged;
            ChatService.OnUsersListChanged -= HandleUsersListChanged;
            ChatService.OnTypingUsersChanged -= HandleTypingUsersChanged;
            ChatService.OnRoomCreated -= HandleRoomCreated;
            ChatService.OnRoomDeleted -= HandleRoomDeleted;
            ChatService.OnAdminChanged -= HandleAdminChanged;
            ChatService.OnDirectMessageReceived -= HandleDirectMessageReceived;
            ChatService.OnDirectMessageUpdated -= HandleDirectMessageUpdated;
            ChatService.OnDirectMessageDeleted -= HandleDirectMessageDeleted;
            ChatService.OnDMTypingUsersChanged -= HandleDMTypingUsersChanged;

            if (isTyping)
            {
                if (currentDMUser != null)
                    await ChatService.StopDMTypingAsync(username, currentDMUser);
                else
                    await ChatService.StopTypingAsync(currentRoomId, username);
            }
            await ChatService.RemoveUserAsync(circuitId);
        }
    }
}
