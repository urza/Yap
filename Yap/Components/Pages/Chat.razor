@page "/"
@rendermode InteractiveServer
@inject ChatService ChatService
@inject ChatConfigService ChatConfig
@inject EmojiService EmojiService
@inject IJSRuntime JS
@inject IWebHostEnvironment Environment
@implements IAsyncDisposable

<PageTitle>@pageTitle</PageTitle>

@if (string.IsNullOrEmpty(username))
{
    <div class="username-container">
        <h2>@welcomeMessage</h2>
        <div class="username-form">
            <input type="text" @bind="usernameInput" @bind:event="oninput"
                   placeholder="@usernamePlaceholder" class="username-input"
                   @onkeypress="HandleUsernameKeyPress" />
            <button class="join-button" @onclick="JoinChat"
                    disabled="@(string.IsNullOrWhiteSpace(usernameInput))">
                @joinButtonText
            </button>
        </div>
    </div>
}
else
{
    <div class="chat-container">
        <div class="chat-header">
            <h3>@roomHeader</h3>
            <div class="header-controls">
                <span class="connection-status connected">@connectionStatus</span>
                <button class="users-toggle" @onclick="ToggleSidebar" title="Toggle users list">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 8.00598C14 10.211 12.206 12.006 10 12.006C7.795 12.006 6 10.211 6 8.00598C6 5.80098 7.795 4.00598 10 4.00598C12.206 4.00598 14 5.80098 14 8.00598ZM2 19.006C2 15.473 5.29 13.006 10 13.006C14.711 13.006 18 15.473 18 19.006V20.006H2V19.006Z"/>
                        <path d="M20.0001 20.006H22.0001V19.006C22.0001 16.4433 20.2697 14.4415 17.5213 13.5352C19.0621 14.9127 20.0001 16.8059 20.0001 19.006V20.006Z"/>
                        <path d="M14.8834 11.9077C16.6657 11.5044 18.0001 9.9077 18.0001 8.00598C18.0001 5.96916 16.4693 4.28218 14.4971 4.0367C15.4322 5.09511 16.0001 6.48524 16.0001 8.00598C16.0001 9.44888 15.4889 10.7742 14.6378 11.8102C14.7203 11.8734 14.8022 11.9388 14.8834 11.9077Z"/>
                    </svg>
                    <span class="online-count">@onlineUsers.Count</span>
                </button>
            </div>
        </div>

        <div class="chat-main">
            <div class="messages-container">
                <div class="messages" @ref="messagesElement">
                    @for (int i = 0; i < messages.Count; i++)
                    {
                        var message = messages[i];
                        var isSystemMessage = message.Username == "System";
                        var showHeader = !isSystemMessage && (i == 0 || messages[i - 1].Username != message.Username);

                        <div class="message-group @(isSystemMessage ? "system-message" : "")">
                            @if (showHeader)
                            {
                                <div class="message-header">
                                    <strong class="message-username">@message.Username</strong>
                                    <span class="message-time">@message.Timestamp.ToLocalTime().ToString("HH:mm")</span>
                                </div>
                            }
                            <div class="message-content">
                                @if (message.IsImage)
                                {
                                    <img src="@message.Content" alt="Uploaded image"
                                         class="message-image" @onclick="() => ShowFullImage(message.Content)" />
                                }
                                else
                                {
                                    @EmojiService.ConvertEmojisToTwemoji(message.Content)
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="message-input-container">
                    <input type="text" @bind="messageInput" @bind:event="oninput" @bind:after="OnMessageInputChanged"
                           placeholder="@messagePlaceholder" class="message-input"
                           @onkeypress="HandleMessageKeyPress" />
                    <label class="image-upload-button">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <InputFile OnChange="HandleFileSelected" accept="image/*" style="display: none;" />
                    </label>
                </div>

                <div class="typing-indicator-container">
                    @if (!string.IsNullOrEmpty(typingIndicatorText))
                    {
                        <div class="typing-indicator">
                            <span style="display: flex; align-items: center; gap: 0.5rem; color: #72767d;">
                                <span class="typing-dots">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </span>
                                <span>@typingIndicatorText</span>
                            </span>
                        </div>
                    }
                </div>
            </div>

            <div class="users-sidebar @(sidebarOpen ? "sidebar-open" : "")">
                <h4>@onlineUsersHeader</h4>
                <div class="users-list">
                    @foreach (var user in onlineUsers)
                    {
                        <div class="user-item @(user == username ? "current-user" : "")">
                            @user
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="sidebar-backdrop @(sidebarOpen ? "show" : "")" @onclick="ToggleSidebar"></div>
    </div>
}

@if (showImageModal)
{
    <div class="image-modal" @onclick="CloseImageModal">
        <img src="@modalImageUrl" alt="Full size image" />
    </div>
}

@code {
    private string circuitId = Guid.NewGuid().ToString();

    // State
    private string username = "";
    private string usernameInput = "";
    private string messageInput = "";
    private List<ChatMessage> messages = new();
    private List<string> onlineUsers = new();
    private List<string> typingUsers = new();
    private ElementReference messagesElement;
    private bool showImageModal = false;
    private string modalImageUrl = "";
    private bool sidebarOpen = false;
    private System.Timers.Timer? typingTimer;
    private bool isTyping = false;

    // Tab notifications
    private int unreadCount = 0;
    private string pageTitle = "Yap";

    // UI Text
    private string welcomeMessage = "";
    private string joinButtonText = "";
    private string usernamePlaceholder = "";
    private string messagePlaceholder = "";
    private string connectionStatus = "";
    private string roomHeader = "";
    private string onlineUsersHeader = "";
    private string typingIndicatorText = "";

    protected override void OnInitialized()
    {
        welcomeMessage = ChatConfig.GetRandomWelcomeMessage();
        joinButtonText = ChatConfig.GetRandomJoinButtonText();
        usernamePlaceholder = ChatConfig.GetRandomUsernamePlaceholder();
        messagePlaceholder = ChatConfig.GetRandomMessagePlaceholder();
        roomHeader = ChatConfig.GetRandomRoomHeader();
        connectionStatus = ChatConfig.GetRandomConnectionStatus(true);
        UpdateOnlineUsersHeader();
        pageTitle = ChatConfig.ProjectName;
    }

    private async Task HandleUsernameKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await JoinChat();
    }

    private async Task HandleMessageKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SendMessage();
    }

    private async Task JoinChat()
    {
        if (string.IsNullOrWhiteSpace(usernameInput)) return;

        username = usernameInput.Trim();

        // Subscribe to events
        ChatService.OnMessageReceived += HandleMessageReceived;
        ChatService.OnUserChanged += HandleUserChanged;
        ChatService.OnUsersListChanged += HandleUsersListChanged;
        ChatService.OnTypingUsersChanged += HandleTypingUsersChanged;

        // Load history
        messages = ChatService.GetRecentMessages().ToList();
        onlineUsers = ChatService.GetOnlineUsers();
        UpdateOnlineUsersHeader();

        // Join chat
        await ChatService.AddUserAsync(circuitId, username);

        // Setup tab notifications
        await SetupTabNotifications();

        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    private async Task HandleMessageReceived(ChatMessage message)
    {
        await InvokeAsync(async () =>
        {
            messages.Add(message);
            StateHasChanged();
            await ScrollToBottom();
            await HandleNewMessageNotification(message.Username);
        });
    }

    private async Task HandleUserChanged(string user, bool isJoining)
    {
        await InvokeAsync(() =>
        {
            messages.Add(new ChatMessage(
                "System",
                ChatConfig.GetRandomSystemMessage(user, isJoining),
                DateTime.UtcNow
            ));
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    private async Task HandleUsersListChanged()
    {
        await InvokeAsync(() =>
        {
            onlineUsers = ChatService.GetOnlineUsers();
            UpdateOnlineUsersHeader();
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    private async Task HandleTypingUsersChanged()
    {
        await InvokeAsync(() =>
        {
            typingUsers = ChatService.GetTypingUsers();
            UpdateTypingIndicator();
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(messageInput)) return;

        await ChatService.SendMessageAsync(username, messageInput);
        messageInput = "";
        await StopTyping();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".webp" };
        var extension = Path.GetExtension(file.Name).ToLowerInvariant();

        if (!allowedExtensions.Contains(extension))
        {
            return;
        }

        if (file.Size > 100 * 1024 * 1024) return;

        try
        {
            var uploadsFolder = Path.Combine(Environment.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsFolder);

            var uniqueFileName = $"{Guid.NewGuid()}{extension}";
            var filePath = Path.Combine(uploadsFolder, uniqueFileName);

            await using var stream = new FileStream(filePath, FileMode.Create);
            await file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024).CopyToAsync(stream);

            var imageUrl = $"/uploads/{uniqueFileName}";
            await ChatService.SendMessageAsync(username, imageUrl, isImage: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading file: {ex.Message}");
        }
    }

    private Task OnMessageInputChanged()
    {
        return HandleTypingChangeAsync(messageInput);
    }

    private async Task HandleTypingChangeAsync(string currentValue)
    {
        if (!string.IsNullOrWhiteSpace(currentValue) && !isTyping)
        {
            await StartTyping();
        }
        else if (string.IsNullOrWhiteSpace(currentValue) && isTyping)
        {
            await StopTyping();
        }

        // Reset typing timer
        typingTimer?.Stop();
        typingTimer?.Dispose();

        if (!string.IsNullOrWhiteSpace(currentValue))
        {
            typingTimer = new System.Timers.Timer(3000);
            typingTimer.Elapsed += async (s, e) =>
            {
                await StopTyping();
                typingTimer?.Dispose();
            };
            typingTimer.Start();
        }
    }

    private async Task StartTyping()
    {
        if (!isTyping)
        {
            isTyping = true;
            await ChatService.StartTypingAsync(username);
        }
    }

    private async Task StopTyping()
    {
        if (isTyping)
        {
            isTyping = false;
            await ChatService.StopTypingAsync(username);
            typingTimer?.Stop();
            typingTimer?.Dispose();
        }
    }

    // Tab notification methods
    private async Task SetupTabNotifications()
    {
        try
        {
            await JS.InvokeVoidAsync("setupVisibilityListener",
                DotNetObjectReference.Create(this));
        }
        catch { }
    }

    private async Task HandleNewMessageNotification(string messageUser)
    {
        if (messageUser != username && messageUser != "System")
        {
            try
            {
                var isVisible = await JS.InvokeAsync<bool>("isPageVisible");
                if (!isVisible)
                {
                    unreadCount++;
                    await UpdateTabTitle();
                    await JS.InvokeVoidAsync("playNotificationSound");
                }
            }
            catch { }
        }
    }

    [JSInvokable]
    public async Task OnPageBecameVisible()
    {
        if (unreadCount > 0)
        {
            unreadCount = 0;
            await UpdateTabTitle();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task UpdateTabTitle()
    {
        var title = unreadCount > 0
            ? $"({unreadCount}) {ChatConfig.ProjectName}"
            : ChatConfig.ProjectName;
        pageTitle = title;
        await InvokeAsync(StateHasChanged);
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JS.InvokeVoidAsync("scrollToBottom", messagesElement);
        }
        catch { }
    }

    private void ShowFullImage(string imageUrl)
    {
        modalImageUrl = imageUrl;
        showImageModal = true;
    }

    private void CloseImageModal()
    {
        showImageModal = false;
        modalImageUrl = "";
    }

    private void ToggleSidebar() => sidebarOpen = !sidebarOpen;

    private void UpdateOnlineUsersHeader() =>
        onlineUsersHeader = ChatConfig.GetRandomOnlineUsersHeader(onlineUsers.Count);

    private void UpdateTypingIndicator() =>
        typingIndicatorText = ChatConfig.GetRandomTypingIndicator(typingUsers, username);

    public async ValueTask DisposeAsync()
    {
        typingTimer?.Stop();
        typingTimer?.Dispose();

        if (!string.IsNullOrEmpty(username))
        {
            ChatService.OnMessageReceived -= HandleMessageReceived;
            ChatService.OnUserChanged -= HandleUserChanged;
            ChatService.OnUsersListChanged -= HandleUsersListChanged;
            ChatService.OnTypingUsersChanged -= HandleTypingUsersChanged;

            if (isTyping)
            {
                await ChatService.StopTypingAsync(username);
            }
            await ChatService.RemoveUserAsync(circuitId);
        }
    }
}
