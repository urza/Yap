@page "/chat"
@page "/lobby"
@page "/room/{RoomId:guid}"
@layout ChatLayout
@inherits ChatBase
@implements IDisposable

<PageTitle>@ChatConfig.ProjectName | @currentContext</PageTitle>

<div class="messages">
    @for (int i = 0; i < messages.Count; i++)
    {
        var message = messages[i];
        var isSystemMessage = message.Username == "System";
        var showHeader = !isSystemMessage && (i == 0 || messages[i - 1].Username != message.Username);

        <MessageItem Username="@message.Username"
                     Content="@message.Content"
                     Timestamp="@message.Timestamp"
                     ShowHeader="@showHeader"
                     IsOwn="@(message.Username == Username)"
                     IsSystem="@isSystemMessage"
                     IsEdited="@message.IsEdited"
                     IsHovered="@(hoveredMessageId == message.Id)"
                     IsEditing="@(editingMessageId == message.Id)"
                     HasImages="@message.HasImages"
                     ImageUrls="@message.ImageUrls"
                     Reactions="@message.Reactions"
                     ShowReactions="true"
                     CurrentUsername="@Username"
                     RecentEmojis="@recentEmojis"
                     EditContent="@editContent"
                     EditContentChanged="@(v => editContent = v)"
                     OnMouseEnter="@(() => hoveredMessageId = message.Id)"
                     OnMouseLeave="@(() => hoveredMessageId = null)"
                     OnReaction="@(emoji => ToggleReaction(message.Id, emoji))"
                     OnStartEdit="@(() => StartEdit(message))"
                     OnSaveEdit="SaveEdit"
                     OnCancelEdit="CancelEdit"
                     OnDelete="@(() => DeleteMessage(message.Id))"
                     OnImageClick="@(args => ShowGallery(args.Images, args.Index))" />
    }
</div>

<MessageInput RoomId="@currentRoomId" />

<ImageGalleryModal Visible="@showImageModal"
                   Images="@modalGallery"
                   StartIndex="@modalImageIndex"
                   OnClose="CloseImageModal" />

@code {
    [Parameter] public Guid? RoomId { get; set; }

    // State
    private Guid currentRoomId;
    private List<ChatMessage> messages = new();
    private Guid? hoveredMessageId = null;
    private Guid? editingMessageId = null;
    private string editContent = "";
    private Guid? previousRoomId = null;

    protected override async Task OnParametersSetAsync()
    {
        // Detect room parameter changes (navigating between rooms)
        var newRoomId = RoomId ?? ChatService.LobbyId;
        if (previousRoomId.HasValue && previousRoomId.Value != newRoomId)
        {
            await SwitchRoomContentAsync(newRoomId);
        }
        previousRoomId = newRoomId;
    }

    protected override async Task OnInitializedChatAsync()
    {
        // Set current room
        currentRoomId = RoomId ?? ChatService.LobbyId;
        previousRoomId = currentRoomId;

        // Load messages
        messages = ChatService.GetRoomMessages(currentRoomId).ToList();

        // Set navigation context
        var room = ChatService.GetRooms().FirstOrDefault(r => r.Id == currentRoomId);
        currentContext = room?.Name ?? "lobby";
        NavState.SetRoomContext(currentRoomId, currentContext);

        await UpdatePageTitleAsync();

        // Subscribe to events
        ChatService.OnMessageReceived += HandleMessageReceived;
        ChatService.OnMessageUpdated += HandleMessageUpdated;
        ChatService.OnMessageDeleted += HandleMessageDeleted;
        ChatService.OnReactionChanged += HandleReactionChanged;
        ChatService.OnUserChanged += HandleUserChanged;
        ChatService.OnRoomDeleted += HandleRoomDeleted;
    }

    private async Task SwitchRoomContentAsync(Guid newRoomId)
    {
        currentRoomId = newRoomId;
        messages = ChatService.GetRoomMessages(currentRoomId).ToList();

        var room = ChatService.GetRooms().FirstOrDefault(r => r.Id == currentRoomId);
        currentContext = room?.Name ?? "lobby";
        NavState.SetRoomContext(currentRoomId, currentContext);

        await UpdatePageTitleAsync();
        await InvokeAsync(StateHasChanged);
        await ScrollToBottomAsync();
    }

    #region Event Handlers

    private async Task HandleMessageReceived(ChatMessage message)
    {
        await InvokeAsync(async () =>
        {
            if (message.RoomId == currentRoomId)
            {
                messages.Add(message);
                StateHasChanged();
                await ScrollToBottomAsync();
            }

            if (message.Username != Username && message.Username != "System")
            {
                await HandleNewMessageNotificationAsync(message.Username, isDM: false);
            }
        });
    }

    private async Task HandleMessageUpdated(ChatMessage message)
    {
        await InvokeAsync(() =>
        {
            if (message.RoomId == currentRoomId)
            {
                var index = messages.FindIndex(m => m.Id == message.Id);
                if (index >= 0) messages[index] = message;
                StateHasChanged();
            }
        });
    }

    private async Task HandleMessageDeleted(Guid messageId, Guid roomId)
    {
        await InvokeAsync(() =>
        {
            if (roomId == currentRoomId)
            {
                messages.RemoveAll(m => m.Id == messageId);
                StateHasChanged();
            }
        });
    }

    private async Task HandleReactionChanged(ChatMessage message)
    {
        await InvokeAsync(() =>
        {
            if (message.RoomId == currentRoomId)
            {
                var index = messages.FindIndex(m => m.Id == message.Id);
                if (index >= 0) messages[index] = message;
                StateHasChanged();
            }
        });
    }

    private async Task HandleUserChanged(string user, bool isJoining)
    {
        await InvokeAsync(() =>
        {
            // Add system message in lobby
            if (currentRoomId == ChatService.LobbyId)
            {
                messages.Add(new ChatMessage(
                    ChatService.LobbyId,
                    "System",
                    ChatConfig.GetRandomSystemMessage(user, isJoining),
                    DateTime.UtcNow
                ));
                StateHasChanged();
            }
        });
    }

    private async Task HandleRoomDeleted(Guid roomId)
    {
        await InvokeAsync(() =>
        {
            if (currentRoomId == roomId)
            {
                Navigation.NavigateTo("/lobby", replace: true);
            }
        });
    }

    #endregion

    #region Message Actions

    private async Task ToggleReaction(Guid messageId, string emoji)
    {
        await AddRecentEmojiAsync(emoji);
        await ChatService.ToggleReactionAsync(messageId, currentRoomId, Username, emoji);
    }

    private void StartEdit(ChatMessage message)
    {
        editingMessageId = message.Id;
        editContent = message.Content;
    }

    private async Task SaveEdit()
    {
        if (editingMessageId.HasValue && !string.IsNullOrWhiteSpace(editContent))
        {
            await ChatService.EditMessageAsync(editingMessageId.Value, currentRoomId, Username, editContent);
        }
        CancelEdit();
    }

    private void CancelEdit()
    {
        editingMessageId = null;
        editContent = "";
    }

    private async Task DeleteMessage(Guid messageId)
    {
        await ChatService.DeleteMessageAsync(messageId, currentRoomId, Username);
    }

    #endregion

    public void Dispose()
    {
        ChatService.OnMessageReceived -= HandleMessageReceived;
        ChatService.OnMessageUpdated -= HandleMessageUpdated;
        ChatService.OnMessageDeleted -= HandleMessageDeleted;
        ChatService.OnReactionChanged -= HandleReactionChanged;
        ChatService.OnUserChanged -= HandleUserChanged;
        ChatService.OnRoomDeleted -= HandleRoomDeleted;
    }
}
