@page "/chat"
@page "/lobby"
@page "/room/{RoomId:guid}"
@layout ChatLayout
@inherits ChatBase
@implements IDisposable

<PageTitle>@ChatConfig.ProjectName | @currentContext</PageTitle>

<div class="messages">
    @for (int i = 0; i < messages.Count; i++)
    {
        var message = messages[i];
        var isSystemMessage = message.Username == "System";
        var showHeader = !isSystemMessage && (i == 0 || messages[i - 1].Username != message.Username);

        <MessageItem Message="@message"
                     ShowHeader="@showHeader"
                     IsHovered="@(hoveredMessageId == message.Id)"
                     IsEditing="@(editingMessageId == message.Id)"
                     CurrentUsername="@Username"
                     RecentEmojis="@recentEmojis"
                     EditContent="@editContent"
                     EditContentChanged="@(v => editContent = v)"
                     OnMouseEnter="@(() => hoveredMessageId = message.Id)"
                     OnMouseLeave="@(() => hoveredMessageId = null)"
                     OnReaction="@(emoji => ToggleReaction(message.Id, emoji))"
                     OnStartEdit="@(() => StartEdit(message))"
                     OnSaveEdit="SaveEdit"
                     OnCancelEdit="CancelEdit"
                     OnDelete="@(() => DeleteMessage(message.Id))"
                     OnImageClick="@(args => ShowGallery(args.Images, args.Index))" />
    }
</div>

<MessageInput RoomId="@channelId" />

<ImageGalleryModal Visible="@showImageModal"
                   Images="@modalGallery"
                   StartIndex="@modalImageIndex"
                   OnClose="CloseImageModal" />

@code {
    [Parameter] public Guid? RoomId { get; set; }

    // Tracks previous room to detect navigation between rooms (e.g., /lobby -> /room/xyz)
    // without component recreation - Blazor reuses the component and just updates parameters
    private Guid? previousRoomId = null;

    protected override async Task OnParametersSetAsync()
    {
        // Detect room parameter changes (navigating between rooms)
        var newRoomId = RoomId ?? ChatService.LobbyId;
        if (previousRoomId.HasValue && previousRoomId.Value != newRoomId)
        {
            await SwitchRoomContentAsync(newRoomId);
        }
        previousRoomId = newRoomId;
    }

    protected override async Task OnInitializedChatAsync()
    {
        // Set current room
        channelId = RoomId ?? ChatService.LobbyId;
        previousRoomId = channelId;

        // Load messages
        messages = ChatService.GetMessages(channelId).ToList();

        // Set navigation context
        var room = ChatService.GetRooms().FirstOrDefault(r => r.Id == channelId);
        currentContext = room?.Name ?? "lobby";
        NavState.SetRoomContext(channelId, currentContext);

        await UpdatePageTitleAsync();

        // Subscribe to events
        ChatService.OnMessageReceived += HandleMessageReceived;
        ChatService.OnMessageUpdated += HandleMessageUpdated;
        ChatService.OnMessageDeleted += HandleMessageDeleted;
        ChatService.OnReactionChanged += HandleReactionChanged;
        ChatService.OnUserChanged += HandleUserChanged;
        ChatService.OnChannelDeleted += HandleChannelDeleted;
    }

    private async Task SwitchRoomContentAsync(Guid newRoomId)
    {
        channelId = newRoomId;
        messages = ChatService.GetMessages(channelId).ToList();

        var room = ChatService.GetRooms().FirstOrDefault(r => r.Id == channelId);
        currentContext = room?.Name ?? "lobby";
        NavState.SetRoomContext(channelId, currentContext);

        await UpdatePageTitleAsync();
        await InvokeAsync(StateHasChanged);
        await ScrollToBottomAsync();
    }

    #region Room-Specific Event Handlers

    private async Task HandleMessageReceived(ChatMessage message)
    {
        await InvokeAsync(async () =>
        {
            if (message.ChannelId == channelId)
            {
                messages.Add(message);
                StateHasChanged();
                await ScrollToBottomAsync();
            }

            if (message.Username != Username && message.Username != "System")
            {
                await HandleNewMessageNotificationAsync(message.Username, isDM: false);
            }
        });
    }

    private async Task HandleUserChanged(string user, bool isJoining)
    {
        await InvokeAsync(() =>
        {
            // Add system message in lobby
            if (channelId == ChatService.LobbyId)
            {
                messages.Add(new ChatMessage(
                    ChatService.LobbyId,
                    "System",
                    ChatConfig.GetRandomSystemMessage(user, isJoining),
                    DateTime.UtcNow
                ));
                StateHasChanged();
            }
        });
    }

    private async Task HandleChannelDeleted(Guid deletedChannelId)
    {
        await InvokeAsync(() =>
        {
            if (channelId == deletedChannelId)
            {
                Navigation.NavigateTo("/lobby", replace: true);
            }
        });
    }

    #endregion

    public void Dispose()
    {
        ChatService.OnMessageReceived -= HandleMessageReceived;
        ChatService.OnMessageUpdated -= HandleMessageUpdated;
        ChatService.OnMessageDeleted -= HandleMessageDeleted;
        ChatService.OnReactionChanged -= HandleReactionChanged;
        ChatService.OnUserChanged -= HandleUserChanged;
        ChatService.OnChannelDeleted -= HandleChannelDeleted;
    }
}
