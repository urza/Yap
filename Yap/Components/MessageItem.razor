@using Yap.Models
@inject EmojiService EmojiService

<div class="message-group @(IsSystem ? "system-message" : "") @(IsHovered ? "hovered" : "") @(showEmojiPicker ? "picker-open" : "")"
     @onmouseenter="() => OnMouseEnter.InvokeAsync()"
     @onmouseleave="() => OnMouseLeave.InvokeAsync()">

    @if (ShowHeader)
    {
        <div class="message-header">
            <strong class="message-username">@Message.Username</strong>
            <span class="message-time">@Message.Timestamp.ToLocalTime().ToString("HH:mm")</span>
        </div>
    }

    <div class="message-content">
        @if (IsEditing)
        {
            <div class="edit-container">
                <input type="text" value="@EditContent" @oninput="OnEditInput"
                       class="edit-input" @onkeydown="HandleEditKeyDown" />
                <div class="edit-actions">
                    <button class="edit-save" @onclick="() => OnSaveEdit.InvokeAsync()" title="Save">‚úì</button>
                    <button class="edit-cancel" @onclick="() => OnCancelEdit.InvokeAsync()" title="Cancel">‚úï</button>
                </div>
            </div>
        }
        else if (Message.HasImages)
        {
            var maxPreview = 4;
            var hasMore = Message.ImageUrls.Count > maxPreview;
            var previewCount = hasMore ? maxPreview : Message.ImageUrls.Count;
            var extraCount = Message.ImageUrls.Count - maxPreview;

            <div class="image-gallery @GetGalleryClass(previewCount)">
                @for (int imgIndex = 0; imgIndex < previewCount; imgIndex++)
                {
                    var idx = imgIndex;
                    var imageUrl = Message.ImageUrls[idx];
                    var isLastPreview = hasMore && idx == maxPreview - 1;

                    <div class="gallery-item @(isLastPreview ? "has-more" : "")"
                         @onclick="() => OnImageClick.InvokeAsync((Message.ImageUrls, idx))">
                        <img src="@imageUrl" alt="Uploaded image" class="gallery-image" />
                        @if (isLastPreview)
                        {
                            <div class="gallery-more-overlay">+@extraCount</div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            @EmojiService.ConvertEmojisToTwemoji(Message.Content)
            @if (Message.IsEdited)
            {
                <span class="edited-indicator">(edited)</span>
            }
        }
    </div>

    @* Reactions display *@
    @if (Message.Reactions?.Count > 0)
    {
        <div class="reactions-display">
            @foreach (var reactionGroup in Message.Reactions.GroupByEmoji())
            {
                var emoji = reactionGroup.Key;
                var users = reactionGroup.Value;
                var hasReacted = users.Any(u => u.Equals(CurrentUsername, StringComparison.OrdinalIgnoreCase));
                <button class="reaction-pill @(hasReacted ? "reacted" : "")"
                        @onclick="() => OnReaction.InvokeAsync(emoji)"
                        title="@string.Join(", ", users)">
                    @EmojiService.ConvertEmojisToTwemoji(emoji, forceSmall: true) <span class="reaction-count">@users.Count</span>
                </button>
            }
        </div>
    }

    @* Message actions popup *@
    @if ((IsHovered || showEmojiPicker) && !IsSystem && !IsEditing)
    {
        <div class="message-actions">
            @foreach (var emoji in GetQuickReactions())
            {
                var e = emoji;
                <button class="action-btn" @onclick="@(() => HandleQuickReaction(e))" title="@e">@EmojiService.ConvertEmojisToTwemoji(e, forceSmall: true)</button>
            }
            <div class="action-divider"></div>
            <button class="action-btn action-picker" @onclick="ToggleEmojiPicker" @onclick:stopPropagation="true" title="Add Reaction">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-6c.78 2.34 2.72 4 5 4s4.22-1.66 5-4H7zm8-4c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm-6 0c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1z"/>
                </svg>
            </button>
            @if (IsOwn && !Message.HasImages)
            {
                <button class="action-btn action-edit" @onclick="() => OnStartEdit.InvokeAsync()" title="Edit">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                </button>
            }
            @if (IsOwn)
            {
                <button class="action-btn action-delete" @onclick="() => OnDelete.InvokeAsync()" title="Delete">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </button>
            }

            @if (showEmojiPicker)
            {
                <EmojiPicker RecentEmojis="RecentEmojis"
                             OnEmojiSelected="HandleEmojiSelected" />
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public ChatMessage Message { get; set; } = default!;
    [Parameter] public bool ShowHeader { get; set; }
    [Parameter] public bool IsHovered { get; set; }
    [Parameter] public bool IsEditing { get; set; }
    [Parameter] public string CurrentUsername { get; set; } = "";
    [Parameter] public List<string> RecentEmojis { get; set; } = new();

    // Computed from Message
    private bool IsOwn => Message.Username.Equals(CurrentUsername, StringComparison.OrdinalIgnoreCase);
    private bool IsSystem => Message.Username == "System";

    // Edit state
    [Parameter] public string EditContent { get; set; } = "";
    [Parameter] public EventCallback<string> EditContentChanged { get; set; }

    // Callbacks
    [Parameter] public EventCallback OnMouseEnter { get; set; }
    [Parameter] public EventCallback OnMouseLeave { get; set; }
    [Parameter] public EventCallback<string> OnReaction { get; set; }
    [Parameter] public EventCallback OnStartEdit { get; set; }
    [Parameter] public EventCallback OnSaveEdit { get; set; }
    [Parameter] public EventCallback OnCancelEdit { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback<(List<string> Images, int Index)> OnImageClick { get; set; }

    private async Task OnEditInput(ChangeEventArgs e)
    {
        await EditContentChanged.InvokeAsync(e.Value?.ToString() ?? "");
    }

    private async Task HandleEditKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await OnSaveEdit.InvokeAsync();
        else if (e.Key == "Escape") await OnCancelEdit.InvokeAsync();
    }

    private static string GetGalleryClass(int imageCount) => imageCount switch
    {
        1 => "gallery-single",
        2 => "gallery-double",
        _ => "gallery-grid"
    };

    // Emoji picker state
    private bool showEmojiPicker = false;
    private static readonly string[] DefaultQuickEmojis = ["‚ù§Ô∏è", "üòÇ", "üëç"];

    private IEnumerable<string> GetQuickReactions()
    {
        // Combine recent emojis with defaults, ensuring 3 unique emojis
        var result = new List<string>();

        // Add recent emojis first
        foreach (var emoji in RecentEmojis.Take(3))
        {
            if (!result.Contains(emoji))
                result.Add(emoji);
        }

        // Fill with defaults if needed
        foreach (var emoji in DefaultQuickEmojis)
        {
            if (result.Count >= 3) break;
            if (!result.Contains(emoji))
                result.Add(emoji);
        }

        return result;
    }

    private void ToggleEmojiPicker()
    {
        showEmojiPicker = !showEmojiPicker;
    }

    private async Task HandleQuickReaction(string emoji)
    {
        await OnReaction.InvokeAsync(emoji);
    }

    private async Task HandleEmojiSelected(string emoji)
    {
        showEmojiPicker = false;
        await OnReaction.InvokeAsync(emoji);
    }
}
