@inject ChatService ChatService
@inject UserStateService UserState
@inject ChatConfigService ChatConfig
@inject ChatNavigationState NavState
@inject NavigationManager Navigation
@implements IDisposable

<div class="users-sidebar @(NavState.SidebarOpen ? "sidebar-open" : "")">
    @* Rooms section *@
    <div class="sidebar-section">
        <h4>ROOMS</h4>
        <div class="rooms-list">
            @foreach (var room in rooms)
            {
                var isActive = NavState.CurrentDmUser == null && NavState.CurrentRoomId == room.Id;
                <div class="room-item @(isActive ? "active" : "")" @onclick="() => SwitchToRoom(room.Id)">
                    <span class="room-icon">#</span>
                    <span class="room-name">@room.Name</span>
                    @if (isAdmin && !room.IsDefault)
                    {
                        <button class="room-delete" @onclick="() => DeleteRoom(room.Id)"
                                @onclick:stopPropagation="true" title="Delete room">√ó</button>
                    }
                </div>
            }
            @if (isAdmin)
            {
                @if (showNewRoomInput)
                {
                    <div class="new-room-input">
                        <input type="text" @bind="newRoomName" @bind:event="oninput"
                               placeholder="room name" class="room-name-input"
                               @onkeypress="HandleNewRoomKeyPress" />
                        <button class="room-create-btn" @onclick="CreateRoom" title="Create">‚úì</button>
                        <button class="room-cancel-btn" @onclick="CancelNewRoom" title="Cancel">‚úï</button>
                    </div>
                }
                else
                {
                    <div class="room-item add-room" @onclick="ShowNewRoomInput">
                        <span class="room-icon">+</span>
                        <span class="room-name">Add Room</span>
                    </div>
                }
            }
        </div>
    </div>

    @* Online users section *@
    <div class="sidebar-section">
        <h4>@onlineUsersHeader</h4>
        <div class="users-list">
            @foreach (var (user, status) in GetSortedUsersWithStatus())
            {
                var isCurrentUser = user.Equals(Username, StringComparison.OrdinalIgnoreCase);
                var isUserAdmin = ChatService.IsAdmin(user);
                var userUnreadCount = isCurrentUser ? 0 : GetUnreadDMCount(user);
                var isActiveDM = NavState.CurrentDmUser != null && NavState.CurrentDmUser.Equals(user, StringComparison.OrdinalIgnoreCase);
                var statusClass = status.ToString().ToLower();

                <div class="user-item @(isCurrentUser ? "current-user" : "") @(isActiveDM ? "active-dm" : "")"
                     @onclick="() => OpenDM(user)"
                     title="@(isCurrentUser ? "You" : $"Message {user}")">
                    <span class="user-status-dot @statusClass"></span>
                    <span class="user-name">@user</span>
                    @if (isUserAdmin)
                    {
                        <span class="admin-badge" title="Admin">üõ°Ô∏è</span>
                    }
                    @if (userUnreadCount > 0)
                    {
                        <span class="dm-unread-badge">@userUnreadCount</span>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string Username => UserState.Username ?? "";

    // Internal state
    private List<Channel> rooms = new();
    private List<(string Username, UserStatus Status)> onlineUsers = new();
    private Dictionary<string, int> dmUnreadCounts = new();
    private bool isAdmin = false;
    private string onlineUsersHeader = "";

    // Room creation UI
    private bool showNewRoomInput = false;
    private string newRoomName = "";

    protected override void OnInitialized()
    {
        // Get initial state
        rooms = ChatService.GetRooms();
        RefreshOnlineUsers();
        isAdmin = ChatService.IsAdmin(Username);
        UpdateOnlineUsersHeader();
        LoadUnreadCounts();

        // Subscribe to events
        ChatService.OnChannelCreated += HandleChannelCreated;
        ChatService.OnChannelDeleted += HandleChannelDeleted;
        ChatService.OnUsersListChanged += HandleUsersListChanged;
        ChatService.OnUserStatusChanged += HandleUserStatusChanged;
        ChatService.OnMessageReceived += HandleMessageReceived;
        ChatService.OnAdminChanged += HandleAdminChanged;
        NavState.OnChange += StateHasChanged;
    }

    private void RefreshOnlineUsers()
    {
        // Get all users with status - invisible users show with gray dot
        onlineUsers = ChatService.GetAllUsersWithStatus();
    }

    private void LoadUnreadCounts()
    {
        dmUnreadCounts.Clear();
        foreach (var (user, _) in onlineUsers)
        {
            if (!user.Equals(Username, StringComparison.OrdinalIgnoreCase))
            {
                var count = ChatService.GetUnreadDMCount(Username, user);
                if (count > 0) dmUnreadCounts[user.ToLowerInvariant()] = count;
            }
        }
    }

    #region Event Handlers

    private async Task HandleChannelCreated(Channel channel)
    {
        await InvokeAsync(() =>
        {
            if (channel.Type == ChannelType.Room)
            {
                rooms = ChatService.GetRooms();
                StateHasChanged();
            }
        });
    }

    private async Task HandleChannelDeleted(Guid channelId)
    {
        await InvokeAsync(() =>
        {
            rooms = ChatService.GetRooms();
            StateHasChanged();
        });
    }

    private async Task HandleUsersListChanged()
    {
        await InvokeAsync(() =>
        {
            RefreshOnlineUsers();
            UpdateOnlineUsersHeader();
            LoadUnreadCounts();
            StateHasChanged();
        });
    }

    private async Task HandleUserStatusChanged(string username, UserStatus status)
    {
        await InvokeAsync(() =>
        {
            RefreshOnlineUsers();
            StateHasChanged();
        });
    }

    private async Task HandleMessageReceived(ChatMessage message)
    {
        await InvokeAsync(() =>
        {
            // Check if this is a DM message for us
            var channel = ChatService.GetChannel(message.ChannelId);
            if (channel?.IsDirectMessage == true)
            {
                var otherUser = channel.GetOtherParticipant(Username);
                if (otherUser != null && !message.Username.Equals(Username, StringComparison.OrdinalIgnoreCase))
                {
                    // Don't increment if we're viewing this DM
                    if (NavState.CurrentDmUser == null ||
                        !NavState.CurrentDmUser.Equals(otherUser, StringComparison.OrdinalIgnoreCase))
                    {
                        var key = otherUser.ToLowerInvariant();
                        if (!dmUnreadCounts.ContainsKey(key)) dmUnreadCounts[key] = 0;
                        dmUnreadCounts[key]++;
                        StateHasChanged();
                    }
                }
            }
        });
    }

    private async Task HandleAdminChanged(string? adminUser)
    {
        await InvokeAsync(() =>
        {
            isAdmin = ChatService.IsAdmin(Username);
            StateHasChanged();
        });
    }

    #endregion

    #region Room Management

    private void SwitchToRoom(Guid roomId)
    {
        var url = roomId == ChatService.GetLobbyId() ? "/lobby" : $"/room/{roomId}";
        Navigation.NavigateTo(url);
    }

    private async Task CreateRoom()
    {
        if (string.IsNullOrWhiteSpace(newRoomName)) return;
        await ChatService.CreateRoomAsync(Username, newRoomName);
        showNewRoomInput = false;
        newRoomName = "";
    }

    private async Task DeleteRoom(Guid roomId)
    {
        await ChatService.DeleteRoomAsync(Username, roomId);
    }

    private void ShowNewRoomInput()
    {
        showNewRoomInput = true;
        newRoomName = "";
    }

    private void CancelNewRoom()
    {
        showNewRoomInput = false;
        newRoomName = "";
    }

    private async Task HandleNewRoomKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await CreateRoom();
        else if (e.Key == "Escape") CancelNewRoom();
    }

    #endregion

    #region DM Management

    private void OpenDM(string targetUser)
    {
        if (targetUser.Equals(Username, StringComparison.OrdinalIgnoreCase)) return;

        // Clear unread count when opening DM
        var key = targetUser.ToLowerInvariant();
        if (dmUnreadCounts.ContainsKey(key))
        {
            dmUnreadCounts[key] = 0;
        }

        Navigation.NavigateTo($"/dm/{Uri.EscapeDataString(targetUser)}");
    }

    private int GetUnreadDMCount(string fromUser)
    {
        var key = fromUser.ToLowerInvariant();
        return dmUnreadCounts.TryGetValue(key, out var count) ? count : 0;
    }

    private IEnumerable<(string Username, UserStatus Status)> GetSortedUsersWithStatus()
    {
        var currentUserEntry = onlineUsers
            .Where(u => u.Username.Equals(Username, StringComparison.OrdinalIgnoreCase));
        var otherUsers = onlineUsers
            .Where(u => !u.Username.Equals(Username, StringComparison.OrdinalIgnoreCase))
            .ToList();

        var sorted = otherUsers
            .Select(u => new
            {
                Entry = u,
                UnreadCount = GetUnreadDMCount(u.Username),
                LastDM = ChatService.GetLastDMTimestamp(Username, u.Username)
            })
            .OrderByDescending(x => x.UnreadCount > 0)
            .ThenByDescending(x => x.LastDM ?? DateTime.MinValue)
            .ThenBy(x => x.Entry.Username)
            .Select(x => x.Entry);

        return currentUserEntry.Concat(sorted);
    }

    #endregion

    #region Helpers

    private void UpdateOnlineUsersHeader()
    {
        onlineUsersHeader = ChatConfig.GetRandomOnlineUsersHeader(onlineUsers.Count);
    }

    #endregion

    public void Dispose()
    {
        ChatService.OnChannelCreated -= HandleChannelCreated;
        ChatService.OnChannelDeleted -= HandleChannelDeleted;
        ChatService.OnUsersListChanged -= HandleUsersListChanged;
        ChatService.OnUserStatusChanged -= HandleUserStatusChanged;
        ChatService.OnMessageReceived -= HandleMessageReceived;
        ChatService.OnAdminChanged -= HandleAdminChanged;
        NavState.OnChange -= StateHasChanged;
    }
}
