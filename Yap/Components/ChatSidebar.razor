@inject ChatService ChatService
@inject UserStateService UserState
@inject ChatConfigService ChatConfig
@inject ChatNavigationState NavState
@inject NavigationManager Navigation
@implements IDisposable

<div class="users-sidebar @(NavState.SidebarOpen ? "sidebar-open" : "")">
    @* Rooms section *@
    <div class="sidebar-section">
        <h4>ROOMS</h4>
        <div class="rooms-list">
            @foreach (var room in rooms)
            {
                var isActive = NavState.CurrentDmUser == null && NavState.CurrentRoomId == room.Id;
                <div class="room-item @(isActive ? "active" : "")" @onclick="() => SwitchToRoom(room.Id)">
                    <span class="room-icon">#</span>
                    <span class="room-name">@room.Name</span>
                    @if (isAdmin && !room.IsDefault)
                    {
                        <button class="room-delete" @onclick="() => DeleteRoom(room.Id)"
                                @onclick:stopPropagation="true" title="Delete room">√ó</button>
                    }
                </div>
            }
            @if (isAdmin)
            {
                @if (showNewRoomInput)
                {
                    <div class="new-room-input">
                        <input type="text" @bind="newRoomName" @bind:event="oninput"
                               placeholder="room name" class="room-name-input"
                               @onkeypress="HandleNewRoomKeyPress" />
                        <button class="room-create-btn" @onclick="CreateRoom" title="Create">‚úì</button>
                        <button class="room-cancel-btn" @onclick="CancelNewRoom" title="Cancel">‚úï</button>
                    </div>
                }
                else
                {
                    <div class="room-item add-room" @onclick="ShowNewRoomInput">
                        <span class="room-icon">+</span>
                        <span class="room-name">Add Room</span>
                    </div>
                }
            }
        </div>
    </div>

    @* Online users section *@
    <div class="sidebar-section">
        <h4>@onlineUsersHeader</h4>
        <div class="users-list">
            @foreach (var user in GetSortedUsers())
            {
                var isCurrentUser = user.Equals(Username, StringComparison.OrdinalIgnoreCase);
                var isUserAdmin = ChatService.IsAdmin(user);
                var userUnreadCount = isCurrentUser ? 0 : GetUnreadDMCount(user);
                var isActiveDM = NavState.CurrentDmUser != null && NavState.CurrentDmUser.Equals(user, StringComparison.OrdinalIgnoreCase);

                <div class="user-item @(isCurrentUser ? "current-user" : "") @(isActiveDM ? "active-dm" : "")"
                     @onclick="() => OpenDM(user)"
                     title="@(isCurrentUser ? "You" : $"Message {user}")">
                    <span class="user-name">@user</span>
                    @if (isUserAdmin)
                    {
                        <span class="admin-badge" title="Admin">üõ°Ô∏è</span>
                    }
                    @if (userUnreadCount > 0)
                    {
                        <span class="dm-unread-badge">@userUnreadCount</span>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string Username => UserState.Username ?? "";

    // Internal state
    private List<Room> rooms = new();
    private List<string> onlineUsers = new();
    private Dictionary<string, int> dmUnreadCounts = new();
    private bool isAdmin = false;
    private string onlineUsersHeader = "";

    // Room creation UI
    private bool showNewRoomInput = false;
    private string newRoomName = "";

    protected override void OnInitialized()
    {
        // Get initial state
        rooms = ChatService.GetRooms();
        onlineUsers = ChatService.GetOnlineUsers();
        isAdmin = ChatService.IsAdmin(Username);
        UpdateOnlineUsersHeader();
        LoadUnreadCounts();

        // Subscribe to events
        ChatService.OnRoomCreated += HandleRoomCreated;
        ChatService.OnRoomDeleted += HandleRoomDeleted;
        ChatService.OnUsersListChanged += HandleUsersListChanged;
        ChatService.OnDirectMessageReceived += HandleDirectMessageReceived;
        ChatService.OnAdminChanged += HandleAdminChanged;
        NavState.OnChange += StateHasChanged;
    }

    private void LoadUnreadCounts()
    {
        dmUnreadCounts.Clear();
        foreach (var user in onlineUsers)
        {
            if (!user.Equals(Username, StringComparison.OrdinalIgnoreCase))
            {
                var count = ChatService.GetUnreadDMCount(Username, user);
                if (count > 0) dmUnreadCounts[user.ToLowerInvariant()] = count;
            }
        }
    }

    #region Event Handlers

    private async Task HandleRoomCreated(Room room)
    {
        await InvokeAsync(() =>
        {
            rooms = ChatService.GetRooms();
            StateHasChanged();
        });
    }

    private async Task HandleRoomDeleted(Guid roomId)
    {
        await InvokeAsync(() =>
        {
            rooms = ChatService.GetRooms();
            StateHasChanged();
        });
    }

    private async Task HandleUsersListChanged()
    {
        await InvokeAsync(() =>
        {
            onlineUsers = ChatService.GetOnlineUsers();
            UpdateOnlineUsersHeader();
            LoadUnreadCounts();
            StateHasChanged();
        });
    }

    private async Task HandleDirectMessageReceived(DirectMessage message)
    {
        await InvokeAsync(() =>
        {
            if (message.ToUser.Equals(Username, StringComparison.OrdinalIgnoreCase))
            {
                // Don't increment if we're viewing this DM
                if (NavState.CurrentDmUser == null ||
                    !NavState.CurrentDmUser.Equals(message.FromUser, StringComparison.OrdinalIgnoreCase))
                {
                    var key = message.FromUser.ToLowerInvariant();
                    if (!dmUnreadCounts.ContainsKey(key)) dmUnreadCounts[key] = 0;
                    dmUnreadCounts[key]++;
                    StateHasChanged();
                }
            }
        });
    }

    private async Task HandleAdminChanged(string? adminUser)
    {
        await InvokeAsync(() =>
        {
            isAdmin = ChatService.IsAdmin(Username);
            StateHasChanged();
        });
    }

    #endregion

    #region Room Management

    private void SwitchToRoom(Guid roomId)
    {
        var url = roomId == ChatService.LobbyId ? "/lobby" : $"/room/{roomId}";
        Navigation.NavigateTo(url);
    }

    private async Task CreateRoom()
    {
        if (string.IsNullOrWhiteSpace(newRoomName)) return;
        await ChatService.CreateRoomAsync(Username, newRoomName);
        showNewRoomInput = false;
        newRoomName = "";
    }

    private async Task DeleteRoom(Guid roomId)
    {
        await ChatService.DeleteRoomAsync(Username, roomId);
    }

    private void ShowNewRoomInput()
    {
        showNewRoomInput = true;
        newRoomName = "";
    }

    private void CancelNewRoom()
    {
        showNewRoomInput = false;
        newRoomName = "";
    }

    private async Task HandleNewRoomKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await CreateRoom();
        else if (e.Key == "Escape") CancelNewRoom();
    }

    #endregion

    #region DM Management

    private void OpenDM(string targetUser)
    {
        if (targetUser.Equals(Username, StringComparison.OrdinalIgnoreCase)) return;

        // Clear unread count when opening DM
        var key = targetUser.ToLowerInvariant();
        if (dmUnreadCounts.ContainsKey(key))
        {
            dmUnreadCounts[key] = 0;
        }

        Navigation.NavigateTo($"/dm/{Uri.EscapeDataString(targetUser)}");
    }

    private int GetUnreadDMCount(string fromUser)
    {
        var key = fromUser.ToLowerInvariant();
        return dmUnreadCounts.TryGetValue(key, out var count) ? count : 0;
    }

    private IEnumerable<string> GetSortedUsers()
    {
        var currentUserList = onlineUsers.Where(u => u.Equals(Username, StringComparison.OrdinalIgnoreCase));
        var otherUsers = onlineUsers.Where(u => !u.Equals(Username, StringComparison.OrdinalIgnoreCase)).ToList();

        var sorted = otherUsers
            .Select(u => new
            {
                User = u,
                UnreadCount = GetUnreadDMCount(u),
                LastDM = ChatService.GetLastDMTimestamp(Username, u)
            })
            .OrderByDescending(x => x.UnreadCount > 0)
            .ThenByDescending(x => x.LastDM ?? DateTime.MinValue)
            .ThenBy(x => x.User)
            .Select(x => x.User);

        return currentUserList.Concat(sorted);
    }

    #endregion

    #region Helpers

    private void UpdateOnlineUsersHeader()
    {
        onlineUsersHeader = ChatConfig.GetRandomOnlineUsersHeader(onlineUsers.Count);
    }

    #endregion

    public void Dispose()
    {
        ChatService.OnRoomCreated -= HandleRoomCreated;
        ChatService.OnRoomDeleted -= HandleRoomDeleted;
        ChatService.OnUsersListChanged -= HandleUsersListChanged;
        ChatService.OnDirectMessageReceived -= HandleDirectMessageReceived;
        ChatService.OnAdminChanged -= HandleAdminChanged;
        NavState.OnChange -= StateHasChanged;
    }
}
