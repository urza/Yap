@inject ChatService ChatService
@inject UserStateService UserState
@inject ChatNavigationState NavState
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<div class="chat-header">
    <h3>@NavState.Title</h3>
    <div class="header-controls">
        <div class="status-dropdown-container">
            <button class="status-button status-@UserState.Status.ToString().ToLower()" @onclick="ToggleDropdown" @onclick:stopPropagation="true">
                <span class="status-indicator"></span>
                <span class="status-username">@UserState.Username</span>
                <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 10l5 5 5-5z"/>
                </svg>
            </button>
            @if (showDropdown)
            {
                <div class="dropdown-backdrop" @onclick="CloseDropdown"></div>
                <div class="status-dropdown">
                    <button class="dropdown-item @(UserState.Status == UserStatus.Online ? "active" : "")" @onclick="() => SetStatus(UserStatus.Online)">
                        <span class="status-dot online"></span>
                        <span>Online</span>
                    </button>
                    <button class="dropdown-item @(UserState.Status == UserStatus.Away ? "active" : "")" @onclick="() => SetStatus(UserStatus.Away)">
                        <span class="status-dot away"></span>
                        <span>Away</span>
                    </button>
                    <button class="dropdown-item @(UserState.Status == UserStatus.Invisible ? "active" : "")" @onclick="() => SetStatus(UserStatus.Invisible)">
                        <span class="status-dot invisible"></span>
                        <span>Invisible</span>
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                        </svg>
                        <span>Settings</span>
                    </button>
                    <button class="dropdown-item signout" @onclick="SignOut">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                        </svg>
                        <span>Sign Out</span>
                    </button>
                </div>
            }
        </div>
        <button class="mailbox-button @(unreadCount > 0 ? "has-unread" : "")"
                @onclick="HandleMailboxClick"
                title="@(unreadCount > 0 ? $"{unreadCount} unread messages" : "Messages")">
            @if (unreadCount > 0)
            {
                @* Filled inbox icon *@
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5v-3h3.56c.69 1.19 1.97 2 3.45 2s2.75-.81 3.45-2H19v3zm0-5h-4.99c0 1.1-.9 2-2 2s-2-.9-2-2H5V5h14v9z"/>
                </svg>
                <span class="mailbox-badge">@unreadCount</span>
            }
            else
            {
                @* Outline inbox icon *@
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-6l-2 3h-4l-2-3H2"/>
                    <path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/>
                </svg>
            }
        </button>
        <button class="users-toggle" @onclick="NavState.ToggleSidebar" title="Toggle sidebar">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14 8.00598C14 10.211 12.206 12.006 10 12.006C7.795 12.006 6 10.211 6 8.00598C6 5.80098 7.795 4.00598 10 4.00598C12.206 4.00598 14 5.80098 14 8.00598ZM2 19.006C2 15.473 5.29 13.006 10 13.006C14.711 13.006 18 15.473 18 19.006V20.006H2V19.006Z"/>
                <path d="M20.0001 20.006H22.0001V19.006C22.0001 16.4433 20.2697 14.4415 17.5213 13.5352C19.0621 14.9127 20.0001 16.8059 20.0001 19.006V20.006Z"/>
                <path d="M14.8834 11.9077C16.6657 11.5044 18.0001 9.9077 18.0001 8.00598C18.0001 5.96916 16.4693 4.28218 14.4971 4.0367C15.4322 5.09511 16.0001 6.48524 16.0001 8.00598C16.0001 9.44888 15.4889 10.7742 14.6378 11.8102C14.7203 11.8734 14.8022 11.9388 14.8834 11.9077Z"/>
            </svg>
            <span class="online-count">@onlineCount</span>
        </button>
    </div>
</div>

@code {
    private int unreadCount = 0;
    private int onlineCount = 0;
    private bool showDropdown = false;

    protected override async Task OnInitializedAsync()
    {
        // Get initial state
        await RefreshUnreadCountAsync();
        onlineCount = ChatService.GetOnlineUsers().Count;

        // Subscribe to events
        ChatService.OnMessageReceived += HandleMessageReceived;
        ChatService.OnUsersListChanged += HandleUsersListChanged;
        NavState.OnChange += HandleNavStateChanged;
    }

    private void ToggleDropdown()
    {
        showDropdown = !showDropdown;
    }

    private void CloseDropdown()
    {
        showDropdown = false;
    }

    private async Task SetStatus(UserStatus status)
    {
        UserState.Status = status;
        if (UserState.SessionId != null)
        {
            await ChatService.SetUserStatusAsync(UserState.SessionId, status);
        }
        showDropdown = false;
    }

    private async Task SignOut()
    {
        showDropdown = false;

        // Remove from chat service
        if (UserState.SessionId != null)
        {
            await ChatService.RemoveUserAsync(UserState.SessionId);
        }

        // Clear user state
        UserState.Username = null;
        UserState.SessionId = null;
        UserState.Status = UserStatus.Online;

        // Navigate to login
        Navigation.NavigateTo("/", forceLoad: true);
    }

    private async Task RefreshUnreadCountAsync()
    {
        if (UserState.Username != null)
        {
            unreadCount = ChatService.GetTotalUnreadDMCount(UserState.Username);
            await UpdateBadgeAsync();
        }
    }

    private async Task UpdateBadgeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("setAppBadge", unreadCount);
        }
        catch
        {
            // Ignore badge errors (not supported, not installed as PWA, etc.)
        }
    }

    private async void HandleNavStateChanged()
    {
        // Refresh unread count when navigation changes (e.g., opening a DM marks messages as read)
        await InvokeAsync(async () =>
        {
            await RefreshUnreadCountAsync();
            StateHasChanged();
        });
    }

    private async Task HandleMessageReceived(ChatMessage message)
    {
        await InvokeAsync(async () =>
        {
            // Check if this is a DM message for us
            var channel = ChatService.GetChannel(message.ChannelId);
            if (channel?.IsDirectMessage == true)
            {
                var otherUser = channel.GetOtherParticipant(UserState.Username ?? "");

                // Only increment if message is not from us and we're NOT currently viewing that DM
                if (!message.Username.Equals(UserState.Username, StringComparison.OrdinalIgnoreCase))
                {
                    var isViewingThisDm = NavState.CurrentDmUser != null &&
                        NavState.CurrentDmUser.Equals(otherUser, StringComparison.OrdinalIgnoreCase);

                    if (!isViewingThisDm)
                    {
                        unreadCount++;
                        await UpdateBadgeAsync();
                        StateHasChanged();
                    }
                }
            }
        });
    }

    private async Task HandleUsersListChanged()
    {
        await InvokeAsync(() =>
        {
            onlineCount = ChatService.GetOnlineUsers().Count;
            StateHasChanged();
        });
    }

    private void HandleMailboxClick()
    {
        NavState.OpenSidebar();
    }

    public void Dispose()
    {
        ChatService.OnMessageReceived -= HandleMessageReceived;
        ChatService.OnUsersListChanged -= HandleUsersListChanged;
        NavState.OnChange -= HandleNavStateChanged;
    }
}
